# Story CL2-049: CLI Validation Commands

**Story ID:** CL2-049
**Epic:** EPIC-CLONE-LAB-V2
**Phase:** 4 - Integration
**Status:** Ready
**Points:** 5
**Author:** Morgan (PM)

---

## Description

Implementar comandos CLI para executar e gerenciar as 63 Validation Tasks. Usuarios devem poder rodar validacoes especificas, ver resultados, e re-executar tasks que falharam.

### Problem Statement
O sistema de 63 Validation Tasks precisa de interface CLI para que usuarios possam executar validacoes e verificar qualidade dos clones.

---

## Acceptance Criteria

```gherkin
Given the user runs validation list command
When validation tasks exist
Then all tasks are displayed with categories

Given the user runs validation execute command
When a valid clone ID is provided
Then all applicable validations are executed

Given the user runs validation run command for a specific task
When the task exists
Then only that task is executed and results shown

Given a validation fails
When the user requests details
Then failure reason and suggestions are displayed

Given validations have been executed
When the user runs validation report command
Then a summary report is generated
```

---

## Technical Requirements

### CLI Validation Commands

```typescript
// packages/cli/src/commands/validation/index.ts

import { Command } from 'commander';

export const validationCommand = new Command('validation')
  .alias('val')
  .description('Run and manage validation tasks')
  .addCommand(listCommand)
  .addCommand(runCommand)
  .addCommand(executeCommand)
  .addCommand(reportCommand)
  .addCommand(categoriesCommand);
```

### List Command

```typescript
// packages/cli/src/commands/validation/list.ts

export const listCommand = new Command('list')
  .alias('ls')
  .description('List all validation tasks')
  .option('-c, --category <category>', 'Filter by category')
  .option('-e, --enabled', 'Show only enabled tasks')
  .option('--json', 'Output as JSON')
  .action(async (options) => {
    const taskRegistry = await getTaskRegistry();
    const tasks = await taskRegistry.listTasks({
      category: options.category,
      enabledOnly: options.enabled
    });

    if (options.json) {
      console.log(JSON.stringify(tasks, null, 2));
      return;
    }

    if (options.category) {
      console.log(formatTaskListByCategory(tasks, options.category));
    } else {
      console.log(formatTaskListAll(tasks));
    }
  });

function formatTaskListAll(tasks: ValidationTask[]): string {
  const byCategory = groupBy(tasks, 'category');
  const lines = [chalk.bold('Validation Tasks (63 total)'), ''];

  const categoryNames: Record<string, string> = {
    extraction: 'Extraction (EX)',
    behavioral: 'Behavioral (BH)',
    values: 'Values (VL)',
    cognitive: 'Cognitive (CG)',
    synthesis: 'Synthesis (SY)',
    implementation: 'Implementation (IM)',
    quality: 'Quality (QA)'
  };

  for (const [category, categoryTasks] of Object.entries(byCategory)) {
    lines.push(chalk.cyan.bold(`${categoryNames[category] || category}:`));
    for (const task of categoryTasks) {
      const status = task.enabled ? chalk.green('[x]') : chalk.gray('[ ]');
      lines.push(`  ${status} ${task.id}: ${task.name}`);
    }
    lines.push('');
  }

  return lines.join('\n');
}
```

### Run Command (Single Task)

```typescript
// packages/cli/src/commands/validation/run.ts

export const runCommand = new Command('run')
  .description('Run a specific validation task')
  .argument('<task-id>', 'Task ID (e.g., EX-001, BH-005)')
  .argument('<clone-id>', 'Clone ID to validate')
  .option('-v, --verbose', 'Show detailed output')
  .option('--fix', 'Attempt to auto-fix issues')
  .action(async (taskId, cloneId, options) => {
    const taskExecutor = await getTaskExecutor();
    const taskRegistry = await getTaskRegistry();

    // Verify task exists
    const task = await taskRegistry.getTask(taskId);
    if (!task) {
      console.error(`Task ${taskId} not found.`);
      console.log('Use "validation list" to see available tasks.');
      process.exit(1);
    }

    console.log(chalk.bold(`Running: ${task.id} - ${task.name}`));
    console.log(`Clone: ${cloneId}`);
    console.log('');

    // Execute
    const spinner = ora('Executing validation...').start();
    const result = await taskExecutor.executeTask(taskId, cloneId, {
      verbose: options.verbose,
      autoFix: options.fix
    });
    spinner.stop();

    // Display result
    console.log(formatTaskResult(result, options.verbose));

    if (result.status === 'pass') {
      console.log(chalk.green.bold('\n[PASS]'));
    } else if (result.status === 'fail') {
      console.log(chalk.red.bold('\n[FAIL]'));
      if (options.fix && result.fixApplied) {
        console.log(chalk.yellow('Auto-fix applied. Re-run validation to verify.'));
      }
    } else {
      console.log(chalk.yellow.bold('\n[WARNING]'));
    }
  });

function formatTaskResult(result: TaskResult, verbose: boolean): string {
  const lines = [
    '',
    `Status: ${formatStatus(result.status)}`,
    `Score: ${result.score}/${result.maxScore}`,
    `Duration: ${result.duration}ms`,
    ''
  ];

  if (result.issues.length > 0) {
    lines.push(chalk.bold('Issues:'));
    for (const issue of result.issues) {
      const icon = issue.severity === 'critical' ? chalk.red('!!!') :
                   issue.severity === 'high' ? chalk.yellow('!!') :
                   chalk.gray('!');
      lines.push(`  ${icon} ${issue.message}`);
      if (verbose && issue.details) {
        lines.push(`     ${issue.details}`);
      }
      if (issue.suggestion) {
        lines.push(chalk.gray(`     Suggestion: ${issue.suggestion}`));
      }
    }
  }

  if (verbose && result.details) {
    lines.push('', chalk.bold('Details:'));
    lines.push(JSON.stringify(result.details, null, 2));
  }

  return lines.join('\n');
}
```

### Execute Command (All Tasks)

```typescript
// packages/cli/src/commands/validation/execute.ts

export const executeCommand = new Command('execute')
  .description('Execute all validation tasks for a clone')
  .argument('<clone-id>', 'Clone ID to validate')
  .option('-c, --category <category>', 'Run only tasks from specific category')
  .option('-p, --parallel', 'Run tasks in parallel', true)
  .option('--fail-fast', 'Stop on first failure')
  .option('--output <file>', 'Save results to file')
  .action(async (cloneId, options) => {
    const taskExecutor = await getTaskExecutor();
    const taskRegistry = await getTaskRegistry();

    // Get tasks to run
    const tasks = await taskRegistry.listTasks({
      category: options.category,
      enabledOnly: true
    });

    console.log(chalk.bold(`Executing ${tasks.length} validation tasks...`));
    console.log(`Clone: ${cloneId}`);
    if (options.category) {
      console.log(`Category: ${options.category}`);
    }
    console.log('');

    // Progress bar
    const progressBar = new cliProgress.SingleBar({
      format: '{bar} {percentage}% | {value}/{total} tasks',
      barCompleteChar: '\u2588',
      barIncompleteChar: '\u2591'
    });
    progressBar.start(tasks.length, 0);

    // Execute
    const results: TaskResult[] = [];
    let failed = false;

    for (let i = 0; i < tasks.length; i++) {
      const task = tasks[i];

      try {
        const result = await taskExecutor.executeTask(task.id, cloneId);
        results.push(result);

        if (result.status === 'fail' && options.failFast) {
          failed = true;
          progressBar.stop();
          console.log(chalk.red(`\nFailed on task ${task.id}`));
          break;
        }
      } catch (error) {
        results.push({
          taskId: task.id,
          status: 'error',
          score: 0,
          maxScore: 100,
          issues: [{ severity: 'critical', message: error.message }],
          duration: 0
        });
      }

      progressBar.update(i + 1);
    }

    progressBar.stop();

    // Summary
    const summary = calculateSummary(results);
    console.log(formatExecutionSummary(summary));

    // Save to file if requested
    if (options.output) {
      await fs.writeFile(
        options.output,
        JSON.stringify({ cloneId, results, summary }, null, 2)
      );
      console.log(`\nResults saved to ${options.output}`);
    }
  });

function calculateSummary(results: TaskResult[]): ExecutionSummary {
  return {
    total: results.length,
    passed: results.filter(r => r.status === 'pass').length,
    failed: results.filter(r => r.status === 'fail').length,
    warnings: results.filter(r => r.status === 'warning').length,
    errors: results.filter(r => r.status === 'error').length,
    averageScore: results.reduce((a, r) => a + r.score, 0) / results.length,
    totalDuration: results.reduce((a, r) => a + r.duration, 0),
    criticalIssues: results.flatMap(r => r.issues)
      .filter(i => i.severity === 'critical').length
  };
}
```

### Report Command

```typescript
// packages/cli/src/commands/validation/report.ts

export const reportCommand = new Command('report')
  .description('Generate validation report for a clone')
  .argument('<clone-id>', 'Clone ID')
  .option('-f, --format <format>', 'Output format (text, json, markdown)', 'text')
  .option('-o, --output <file>', 'Save to file')
  .action(async (cloneId, options) => {
    const reportGenerator = await getValidationReportGenerator();
    const report = await reportGenerator.generate(cloneId);

    const formatted = formatValidationReport(report, options.format);

    if (options.output) {
      await fs.writeFile(options.output, formatted);
      console.log(`Report saved to ${options.output}`);
    } else {
      console.log(formatted);
    }
  });

function formatValidationReport(report: ValidationReport, format: string): string {
  switch (format) {
    case 'json':
      return JSON.stringify(report, null, 2);
    case 'markdown':
      return formatReportMarkdown(report);
    default:
      return formatReportText(report);
  }
}

function formatReportText(report: ValidationReport): string {
  const lines = [
    chalk.bold('Validation Report'),
    chalk.bold('================='),
    '',
    `Clone ID: ${report.cloneId}`,
    `Generated: ${formatDate(report.generatedAt)}`,
    '',
    chalk.bold('Summary'),
    '-------',
    `Overall Score: ${report.overallScore}/100`,
    `Status: ${formatStatus(report.overallStatus)}`,
    '',
    `Passed: ${report.summary.passed}/${report.summary.total}`,
    `Failed: ${report.summary.failed}`,
    `Warnings: ${report.summary.warnings}`,
    '',
    chalk.bold('By Category'),
    '-----------'
  ];

  for (const [category, stats] of Object.entries(report.byCategory)) {
    const pct = Math.round((stats.passed / stats.total) * 100);
    const bar = progressBar(pct, 20);
    lines.push(`  ${category.padEnd(14)} ${bar} ${stats.passed}/${stats.total}`);
  }

  if (report.criticalIssues.length > 0) {
    lines.push('', chalk.bold.red('Critical Issues'), '----------------');
    for (const issue of report.criticalIssues) {
      lines.push(`  - [${issue.taskId}] ${issue.message}`);
    }
  }

  return lines.join('\n');
}
```

### Categories Command

```typescript
// packages/cli/src/commands/validation/categories.ts

export const categoriesCommand = new Command('categories')
  .description('List validation task categories')
  .action(async () => {
    const categories = [
      { id: 'extraction', prefix: 'EX', count: 10, description: 'Source data extraction validation' },
      { id: 'behavioral', prefix: 'BH', count: 12, description: 'Behavioral pattern validation' },
      { id: 'values', prefix: 'VL', count: 8, description: 'Values and beliefs validation' },
      { id: 'cognitive', prefix: 'CG', count: 11, description: 'Cognitive architecture validation' },
      { id: 'synthesis', prefix: 'SY', count: 9, description: 'Synthesis quality validation' },
      { id: 'implementation', prefix: 'IM', count: 7, description: 'Implementation readiness validation' },
      { id: 'quality', prefix: 'QA', count: 6, description: 'Overall quality assurance validation' }
    ];

    console.log(chalk.bold('Validation Categories'));
    console.log(chalk.bold('====================='));
    console.log('');

    for (const cat of categories) {
      console.log(`${chalk.cyan(cat.prefix)} ${chalk.bold(cat.id)} (${cat.count} tasks)`);
      console.log(`  ${cat.description}`);
      console.log('');
    }

    console.log(`Total: ${categories.reduce((a, c) => a + c.count, 0)} tasks`);
  });
```

---

## Business Value

Comandos CLI para validacao permitem usuarios executar e verificar as 63 Validation Tasks de forma flexivel e detalhada.

**Beneficios:**
- Execucao granular de validacoes
- Feedback detalhado de falhas
- Relatorios completos
- Execucao paralela para performance
- Suporte a auto-fix

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Execucao muito lenta | Medium | Low | Execucao paralela + progress bar |
| Output muito verboso | Medium | Low | Opcoes de verbosity |
| Auto-fix causa problemas | Low | Medium | Confirmacao + rollback |
| Relatorio muito grande | Low | Low | Filtros e paginacao |

---

## Scope

### In Scope
- validation list command
- validation run command (single task)
- validation execute command (all tasks)
- validation report command
- validation categories command
- Progress indicators
- Multiple output formats

### Out of Scope
- Web UI for validation
- Distributed validation
- Real-time validation streaming

---

## Dependencies

| Dependency | Type | Status |
|------------|------|--------|
| CL2-012 (Validation Task Interface) | Package | Pending |
| CL2-013 to CL2-019 (Tasks) | Package | Pending |
| CL2-020 (Task Registry & Executor) | Package | Pending |
| CLI Package | Package | Available |

---

## Dev Notes

### Progress Bar Helper

```typescript
function progressBar(percentage: number, width: number): string {
  const filled = Math.round((percentage / 100) * width);
  const empty = width - filled;
  return chalk.green('█'.repeat(filled)) + chalk.gray('░'.repeat(empty));
}
```

### Status Colors

```typescript
function formatStatus(status: string): string {
  switch (status) {
    case 'pass': return chalk.green('PASS');
    case 'fail': return chalk.red('FAIL');
    case 'warning': return chalk.yellow('WARNING');
    case 'error': return chalk.red('ERROR');
    case 'pending': return chalk.blue('PENDING');
    default: return status;
  }
}
```

---

## File List

| File | Action | Status |
|------|--------|--------|
| `packages/cli/src/commands/validation/index.ts` | Create | Pending |
| `packages/cli/src/commands/validation/list.ts` | Create | Pending |
| `packages/cli/src/commands/validation/run.ts` | Create | Pending |
| `packages/cli/src/commands/validation/execute.ts` | Create | Pending |
| `packages/cli/src/commands/validation/report.ts` | Create | Pending |
| `packages/cli/src/commands/validation/categories.ts` | Create | Pending |
| `packages/cli/src/commands/validation/format.ts` | Create | Pending |
| `packages/cli/src/__tests__/validation.test.ts` | Create | Pending |

---

## Definition of Done

- [ ] validation list shows all 63 tasks
- [ ] validation run executes single task
- [ ] validation execute runs all tasks
- [ ] validation report generates summary
- [ ] validation categories displays info
- [ ] Progress indicators work
- [ ] Multiple output formats supported
- [ ] Lint passa sem erros
- [ ] Code review aprovado

---

## QA Checklist

- [ ] All commands execute correctly
- [ ] Task filtering works
- [ ] Progress indicators accurate
- [ ] Error messages helpful
- [ ] Reports complete and accurate
- [ ] Performance acceptable

---

## Change Log

| Date | Author | Description |
|------|--------|-------------|
| 2026-02-20 | Morgan (PM) | Story created |

---

*Story generated by Morgan (PM Agent) - AIOS Framework*
