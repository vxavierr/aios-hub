# Story CL2-029: Metrics Collector

**Story ID:** CL2-029
**Epic:** EPIC-CLONE-LAB-V2
**Phase:** 3 - Meta-Cognition
**Status:** Ready
**Points:** 5
**Author:** Morgan (PM)

---

## Description

Implementar o **Metrics Collector** - componente responsável por coletar, agregar e persistir métricas do sistema Clone Lab para análise de performance e auto-avaliação.

### Problem Statement
O sistema de meta-cognição precisa de dados para analisar. O Metrics Collector coleta métricas de performance, qualidade e uso dos componentes do Clone Lab, fornecendo a base para auto-avaliação e identificação de melhorias.

---

## Acceptance Criteria

```gherkin
Given the system is running
When a clone operation is performed
Then relevant metrics are collected and stored

Given metrics have been collected over time
When an aggregation query is made
Then aggregated results are returned efficiently

Given the metrics storage grows large
When retention policies are applied
Then old metrics are archived or purged correctly
```

---

## Technical Requirements

### Metrics Collector Interface

```typescript
// packages/meta/src/metrics/collector.ts

export interface MetricDefinition {
  name: string;
  type: 'counter' | 'gauge' | 'histogram' | 'summary';
  description: string;
  labels: string[];
  retention: RetentionPolicy;
}

export interface RetentionPolicy {
  raw: Duration;           // Keep raw data
  hourly: Duration;        // Keep hourly aggregates
  daily: Duration;         // Keep daily aggregates
}

export class MetricsCollector {
  private readonly storage: MetricsStorage;
  private readonly definitions: Map<string, MetricDefinition>;
  private readonly buffer: MetricBuffer;

  constructor(config: MetricsConfig) {
    this.storage = new MetricsStorage(config.storage);
    this.definitions = new Map();
    this.buffer = new MetricBuffer(config.bufferSize);
  }

  // Record a metric value
  record(
    name: string,
    value: number,
    labels: Record<string, string> = {}
  ): void {
    const definition = this.definitions.get(name);
    if (!definition) {
      throw new Error(`Unknown metric: ${name}`);
    }

    const metric: MetricData = {
      name,
      value,
      timestamp: new Date(),
      tags: labels
    };

    this.buffer.add(metric);
  }

  // Increment a counter
  increment(
    name: string,
    labels: Record<string, string> = {}
  ): void {
    this.record(name, 1, labels);
  }

  // Get aggregated metrics
  async getAggregated(
    name: string,
    range: TimeRange,
    aggregation: 'sum' | 'avg' | 'max' | 'min' | 'count'
  ): Promise<AggregatedMetric[]> {
    return this.storage.query({
      metricName: name,
      range,
      aggregation
    });
  }

  // Register a new metric
  register(definition: MetricDefinition): void {
    this.definitions.set(definition.name, definition);
  }

  // Flush buffer to storage
  async flush(): Promise<void> {
    const metrics = this.buffer.drain();
    await this.storage.batchWrite(metrics);
  }
}
```

### Clone Lab Metrics Definitions

```typescript
// packages/meta/src/metrics/definitions.ts

export const CLONE_LAB_METRICS: MetricDefinition[] = [
  // Clone operation metrics
  {
    name: 'clone_operations_total',
    type: 'counter',
    description: 'Total number of clone operations',
    labels: ['status', 'mind'],
    retention: { raw: '7d', hourly: '30d', daily: '365d' }
  },
  {
    name: 'clone_fidelity_score',
    type: 'gauge',
    description: 'Fidelity score of completed clones',
    labels: ['mind', 'checkpoint'],
    retention: { raw: '30d', hourly: '90d', daily: '365d' }
  },
  {
    name: 'clone_operation_duration_seconds',
    type: 'histogram',
    description: 'Duration of clone operations',
    labels: ['phase', 'mind'],
    retention: { raw: '7d', hourly: '30d', daily: '90d' }
  },

  // Mind metrics
  {
    name: 'mind_analysis_duration_seconds',
    type: 'histogram',
    description: 'Duration of mind analysis',
    labels: ['mind_id'],
    retention: { raw: '7d', hourly: '30d', daily: '90d' }
  },
  {
    name: 'mind_confidence_score',
    type: 'gauge',
    description: 'Confidence score of mind analysis',
    labels: ['mind_id'],
    retention: { raw: '30d', hourly: '90d', daily: '365d' }
  },

  // Validation metrics
  {
    name: 'validation_task_executions_total',
    type: 'counter',
    description: 'Total validation task executions',
    labels: ['task_id', 'result'],
    retention: { raw: '7d', hourly: '30d', daily: '365d' }
  },
  {
    name: 'validation_task_duration_seconds',
    type: 'histogram',
    description: 'Duration of validation tasks',
    labels: ['task_category'],
    retention: { raw: '7d', hourly: '30d', daily: '90d' }
  },

  // Checkpoint metrics
  {
    name: 'checkpoint_reviews_total',
    type: 'counter',
    description: 'Total checkpoint reviews',
    labels: ['checkpoint_id', 'decision'],
    retention: { raw: '30d', hourly: '90d', daily: '365d' }
  },
  {
    name: 'checkpoint_review_duration_seconds',
    type: 'histogram',
    description: 'Duration of checkpoint reviews',
    labels: ['checkpoint_id'],
    retention: { raw: '7d', hourly: '30d', daily: '90d' }
  },

  // System health
  {
    name: 'system_bottleneck_events_total',
    type: 'counter',
    description: 'Total bottleneck events detected',
    labels: ['component', 'severity'],
    retention: { raw: '7d', hourly: '30d', daily: '90d' }
  }
];
```

### Metrics Storage

```typescript
// packages/meta/src/metrics/storage.ts

export interface MetricsStorage {
  write(metric: MetricData): Promise<void>;
  batchWrite(metrics: MetricData[]): Promise<void>;
  query(query: MetricsQuery): Promise<AggregatedMetric[]>;
  purge(policy: RetentionPolicy): Promise<void>;
}

export class FileMetricsStorage implements MetricsStorage {
  private readonly basePath: string;
  private readonly index: MetricsIndex;

  constructor(config: StorageConfig) {
    this.basePath = config.path;
    this.index = new MetricsIndex(config.indexPath);
  }

  async batchWrite(metrics: MetricData[]): Promise<void> {
    // Group by hour for efficient storage
    const grouped = this.groupByHour(metrics);

    for (const [hour, hourMetrics] of grouped) {
      const file = this.getFilePath(hour);
      await this.appendToFile(file, hourMetrics);
      await this.index.update(hour, hourMetrics);
    }
  }

  async query(query: MetricsQuery): Promise<AggregatedMetric[]> {
    const files = this.index.findFiles(query.metricName, query.range);
    const results: AggregatedMetric[] = [];

    for (const file of files) {
      const data = await this.readFile(file);
      const filtered = this.filterByQuery(data, query);
      results.push(...this.aggregate(filtered, query));
    }

    return results;
  }
}
```

---

## Business Value

O Metrics Collector fornece os **dados brutos** para todo o sistema de meta-cognição. Sem métricas, não há como identificar gargalos, medir qualidade, ou avaliar melhorias.

**Benefícios:**
- Base de dados para auto-avaliação
- Identificação de gargalos de performance
- Histórico de evolução do sistema
- Suporte a alertas e dashboards

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Storage grows unbounded | High | Medium | Retention policies + aggregation |
| Performance overhead | Medium | Medium | Async writes + buffering |
| Lost metrics on crash | Low | Medium | Frequent flush + recovery logs |

---

## Scope

### In Scope
- MetricsCollector class
- File-based metrics storage
- Pre-defined Clone Lab metrics
- Retention policies
- Aggregation queries

### Out of Scope
- Time-series database integration
- Real-time dashboards
- Alert system

---

## Dependencies

| Dependency | Type | Status |
|------------|------|--------|
| CL2-028 (Meta Package Setup) | Package | Pending |
| @clone-lab/core | Package | Available |

---

## Dev Notes

### Metric Naming Convention

Follow Prometheus naming conventions:
- `*_total` for counters
- `_seconds` for time durations
- `_bytes` for sizes
- Use snake_case

### Flush Strategy

```typescript
// Auto-flush every 10 seconds or 1000 metrics
const FLUSH_INTERVAL_MS = 10000;
const FLUSH_THRESHOLD = 1000;
```

---

## File List

| File | Action | Status |
|------|--------|--------|
| `packages/meta/src/metrics/collector.ts` | Create | Pending |
| `packages/meta/src/metrics/storage.ts` | Create | Pending |
| `packages/meta/src/metrics/definitions.ts` | Create | Pending |
| `packages/meta/src/metrics/buffer.ts` | Create | Pending |
| `packages/meta/src/metrics/index.ts` | Create | Pending |
| `packages/meta/src/metrics/__tests__/collector.test.ts` | Create | Pending |

---

## Definition of Done

- [ ] MetricsCollector records metrics correctly
- [ ] Storage persists metrics to files
- [ ] Aggregation queries return correct results
- [ ] Retention policies work as expected
- [ ] Buffer flushes correctly
- [ ] All Clone Lab metrics registered
- [ ] Lint passa sem erros
- [ ] Code review aprovado

---

## QA Checklist

- [ ] MetricsCollector records metrics correctly
- [ ] Storage persists metrics to files
- [ ] Aggregation queries return correct results
- [ ] Retention policies work as expected
- [ ] Buffer flushes correctly
- [ ] All tests pass

---

## Change Log

| Date | Author | Description |
|------|--------|-------------|
| 2026-02-20 | Morgan (PM) | Story created |

---

*Story generated by Morgan (PM Agent) - AIOS Framework*
