# Story CL2-047: CLI Checkpoint Commands

**Story ID:** CL2-047
**Epic:** EPIC-CLONE-LAB-V2
**Phase:** 4 - Integration
**Status:** Ready
**Points:** 5
**Author:** Morgan (PM)

---

## Description

Implementar comandos CLI para gerenciar os 6 Human Checkpoints do pipeline. Usuarios devem poder listar, aprovar, rejeitar e pular checkpoints via linha de comando.

### Problem Statement
O sistema de 6 Checkpoints precisa de interface CLI para que usuarios possam interagir com os gates humanos durante o processo de criacao de clones.

---

## Acceptance Criteria

```gherkin
Given a clone pipeline is running
When a checkpoint is reached
Then the CLI displays checkpoint details and prompts for action

Given the user runs checkpoint list command
When there are pending checkpoints
Then all pending checkpoints are displayed with details

Given a checkpoint is pending
When user approves it via CLI
Then the pipeline continues to next phase

Given a checkpoint is pending
When user rejects it via CLI
Then the pipeline halts and requests changes

Given a checkpoint is optional
When user skips it via CLI
Then the pipeline continues with a warning logged
```

---

## Technical Requirements

### CLI Checkpoint Commands

```typescript
// packages/cli/src/commands/checkpoint/index.ts

import { Command } from 'commander';

export const checkpointCommand = new Command('checkpoint')
  .description('Manage pipeline checkpoints')
  .addCommand(listCommand)
  .addCommand(approveCommand)
  .addCommand(rejectCommand)
  .addCommand(skipCommand)
  .addCommand(showCommand);
```

### List Command

```typescript
// packages/cli/src/commands/checkpoint/list.ts

export const listCommand = new Command('list')
  .alias('ls')
  .description('List all checkpoints for a clone')
  .argument('<clone-id>', 'Clone ID to list checkpoints for')
  .option('-s, --status <status>', 'Filter by status (pending, approved, rejected, skipped)')
  .option('-a, --all', 'Show all checkpoints including completed')
  .action(async (cloneId, options) => {
    const checkpointManager = await getCheckpointManager();
    const checkpoints = await checkpointManager.getCheckpoints(cloneId, {
      status: options.status,
      all: options.all
    });

    if (checkpoints.length === 0) {
      console.log('No checkpoints found.');
      return;
    }

    console.log(formatCheckpointList(checkpoints));
  });

function formatCheckpointList(checkpoints: Checkpoint[]): string {
  const lines = ['ID       | Name                    | Status    | Phase'];
  lines.push('-'.repeat(60));

  for (const cp of checkpoints) {
    const status = formatStatus(cp.status);
    lines.push(
      `${cp.id.padEnd(8)} | ${cp.name.padEnd(23)} | ${status.padEnd(9)} | ${cp.phase}`
    );
  }

  return lines.join('\n');
}
```

### Approve Command

```typescript
// packages/cli/src/commands/checkpoint/approve.ts

export const approveCommand = new Command('approve')
  .description('Approve a checkpoint')
  .argument('<checkpoint-id>', 'Checkpoint ID to approve')
  .option('-m, --message <message>', 'Approval message')
  .option('-c, --conditions <conditions...>', 'Conditions for approval')
  .action(async (checkpointId, options) => {
    const checkpointManager = await getCheckpointManager();

    // Show checkpoint details first
    const checkpoint = await checkpointManager.getCheckpoint(checkpointId);
    console.log(formatCheckpointDetails(checkpoint));

    // Confirm approval
    const confirmed = await confirmApproval(checkpoint);
    if (!confirmed) {
      console.log('Approval cancelled.');
      return;
    }

    // Approve
    await checkpointManager.approve(checkpointId, {
      message: options.message,
      conditions: options.conditions,
      approvedBy: getCurrentUser(),
      approvedAt: new Date()
    });

    console.log(`Checkpoint ${checkpointId} approved.`);
    console.log('Pipeline will continue to next phase.');
  });

async function confirmApproval(checkpoint: Checkpoint): Promise<boolean> {
  const answers = await inquirer.prompt([
    {
      type: 'confirm',
      name: 'confirm',
      message: `Approve checkpoint "${checkpoint.name}"?`,
      default: false
    }
  ]);
  return answers.confirm;
}
```

### Reject Command

```typescript
// packages/cli/src/commands/checkpoint/reject.ts

export const rejectCommand = new Command('reject')
  .description('Reject a checkpoint')
  .argument('<checkpoint-id>', 'Checkpoint ID to reject')
  .requiredOption('-r, --reason <reason>', 'Rejection reason (required)')
  .option('-f, --feedback <feedback>', 'Detailed feedback for improvement')
  .action(async (checkpointId, options) => {
    const checkpointManager = await getCheckpointManager();

    // Show checkpoint details
    const checkpoint = await checkpointManager.getCheckpoint(checkpointId);
    console.log(formatCheckpointDetails(checkpoint));

    // Confirm rejection
    const confirmed = await confirmRejection(checkpoint, options.reason);
    if (!confirmed) {
      console.log('Rejection cancelled.');
      return;
    }

    // Reject
    await checkpointManager.reject(checkpointId, {
      reason: options.reason,
      feedback: options.feedback,
      rejectedBy: getCurrentUser(),
      rejectedAt: new Date()
    });

    console.log(`Checkpoint ${checkpointId} rejected.`);
    console.log('Pipeline is paused. Address feedback and resubmit.');
  });
```

### Skip Command

```typescript
// packages/cli/src/commands/checkpoint/skip.ts

export const skipCommand = new Command('skip')
  .description('Skip an optional checkpoint')
  .argument('<checkpoint-id>', 'Checkpoint ID to skip')
  .option('-r, --reason <reason>', 'Reason for skipping')
  .action(async (checkpointId, options) => {
    const checkpointManager = await getCheckpointManager();
    const checkpoint = await checkpointManager.getCheckpoint(checkpointId);

    if (!checkpoint.isOptional) {
      console.error('Error: This checkpoint is required and cannot be skipped.');
      process.exit(1);
    }

    // Warning
    console.log(chalk.yellow('Warning: Skipping this checkpoint may affect clone quality.'));
    console.log(`Checkpoint: ${checkpoint.name}`);
    console.log(`Purpose: ${checkpoint.purpose}`);

    const confirmed = await inquirer.prompt([
      {
        type: 'confirm',
        name: 'skip',
        message: 'Skip this checkpoint?',
        default: false
      }
    ]);

    if (!confirmed.skip) {
      console.log('Skip cancelled.');
      return;
    }

    await checkpointManager.skip(checkpointId, {
      reason: options.reason || 'User opted to skip',
      skippedBy: getCurrentUser(),
      skippedAt: new Date()
    });

    console.log(`Checkpoint ${checkpointId} skipped.`);
    console.log(chalk.yellow('A warning has been logged to the clone audit trail.'));
  });
```

### Show Command

```typescript
// packages/cli/src/commands/checkpoint/show.ts

export const showCommand = new Command('show')
  .description('Show detailed checkpoint information')
  .argument('<checkpoint-id>', 'Checkpoint ID to show')
  .option('-j, --json', 'Output as JSON')
  .action(async (checkpointId, options) => {
    const checkpointManager = await getCheckpointManager();
    const checkpoint = await checkpointManager.getCheckpoint(checkpointId);

    if (!checkpoint) {
      console.error(`Checkpoint ${checkpointId} not found.`);
      process.exit(1);
    }

    if (options.json) {
      console.log(JSON.stringify(checkpoint, null, 2));
    } else {
      console.log(formatCheckpointDetails(checkpoint));
    }
  });

function formatCheckpointDetails(checkpoint: Checkpoint): string {
  const lines = [
    `Checkpoint: ${checkpoint.name}`,
    `ID: ${checkpoint.id}`,
    `Status: ${formatStatus(checkpoint.status)}`,
    `Phase: ${checkpoint.phase}`,
    `Required: ${checkpoint.isRequired ? 'Yes' : 'No'}`,
    '',
    `Purpose: ${checkpoint.purpose}`,
    '',
    'Validation Criteria:'
  ];

  for (const criterion of checkpoint.criteria) {
    const status = criterion.passed ? chalk.green('[x]') : chalk.red('[ ]');
    lines.push(`  ${status} ${criterion.description}`);
  }

  if (checkpoint.feedback) {
    lines.push('', 'Feedback:', checkpoint.feedback);
  }

  return lines.join('\n');
}
```

---

## Business Value

Comandos CLI para checkpoints permitem que usuarios gerenciem os gates humanos de forma eficiente sem precisar de UI grafica.

**Beneficios:**
- Controle total sobre checkpoints via CLI
- Workflow interativo e informativo
- Confirmacoes para evitar erros
- Feedback estruturado para rejeicoes
- Audit trail completo

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Usuario aprova por engano | Medium | Medium | Confirmacao obrigatoria |
| Rejeicao sem feedback util | Medium | Low | Feedback obrigatorio ou sugerido |
| CLI travado esperando input | Low | Low | Timeout com default seguro |
| Comando mal formatado | Low | Low | Validacao e help claro |

---

## Scope

### In Scope
- checkpoint list command
- checkpoint approve command
- checkpoint reject command
- checkpoint skip command
- checkpoint show command
- Interactive confirmations
- Formatted output

### Out of Scope
- Batch checkpoint operations
- Checkpoint templates
- Web UI for checkpoints

---

## Dependencies

| Dependency | Type | Status |
|------------|------|--------|
| CL2-021 (Checkpoint Manager) | Package | Pending |
| CL2-022 to CL2-027 (Checkpoints) | Package | Pending |
| CLI Package | Package | Available |
| Inquirer.js | Runtime | Available |

---

## Dev Notes

### Checkpoint Status Colors

```typescript
function formatStatus(status: CheckpointStatus): string {
  switch (status) {
    case 'pending':
      return chalk.yellow('pending');
    case 'approved':
      return chalk.green('approved');
    case 'rejected':
      return chalk.red('rejected');
    case 'skipped':
      return chalk.gray('skipped');
    default:
      return status;
  }
}
```

---

## File List

| File | Action | Status |
|------|--------|--------|
| `packages/cli/src/commands/checkpoint/index.ts` | Create | Pending |
| `packages/cli/src/commands/checkpoint/list.ts` | Create | Pending |
| `packages/cli/src/commands/checkpoint/approve.ts` | Create | Pending |
| `packages/cli/src/commands/checkpoint/reject.ts` | Create | Pending |
| `packages/cli/src/commands/checkpoint/skip.ts` | Create | Pending |
| `packages/cli/src/commands/checkpoint/show.ts` | Create | Pending |
| `packages/cli/src/commands/checkpoint/format.ts` | Create | Pending |
| `packages/cli/src/__tests__/checkpoint.test.ts` | Create | Pending |

---

## Definition of Done

- [ ] checkpoint list shows all checkpoints
- [ ] checkpoint approve works with confirmation
- [ ] checkpoint reject requires reason
- [ ] checkpoint skip warns and confirms
- [ ] checkpoint show displays details
- [ ] Interactive prompts work correctly
- [ ] Colors and formatting clear
- [ ] Lint passa sem erros
- [ ] Code review aprovado

---

## QA Checklist

- [ ] All commands execute correctly
- [ ] Confirmations prevent accidental actions
- [ ] Output is readable and informative
- [ ] Error messages are helpful
- [ ] Help text is complete
- [ ] JSON output option works

---

## Change Log

| Date | Author | Description |
|------|--------|-------------|
| 2026-02-20 | Morgan (PM) | Story created |

---

*Story generated by Morgan (PM Agent) - AIOS Framework*
