# Story CL2-044: Minds to Analyzers Migration

**Story ID:** CL2-044
**Epic:** EPIC-CLONE-LAB-V2
**Phase:** 4 - Integration
**Status:** Ready
**Points:** 8
**Author:** Morgan (PM)

---

## Description

Migrar o sistema existente de Analyzers (Clone Lab v1.0) para usar as novas 8 Minds. Esta Ã© a story de integracao principal que conecta o novo sistema de Minds ao pipeline existente, garantindo compatibilidade e migracao suave.

### Problem Statement
O Clone Lab v1.0 usa um sistema de Analyzers que precisa ser substituido pelas 8 Minds especializadas. A migracao deve ser transparente para os usuarios finais enquanto mantem toda a funcionalidade existente.

---

## Acceptance Criteria

```gherkin
Given the existing Clone Lab v1.0 pipeline
When Minds system is activated
Then all analyzer functions are mapped to corresponding Minds

Given a clone analysis request
When processed through the new system
Then results are equivalent or better than v1.0 analyzers

Given legacy analyzer configurations
When migration runs
Then configurations are converted to Mind-compatible format

Given a migration error occurs
When rollback is triggered
Then the system reverts to v1.0 analyzers without data loss
```

---

## Technical Requirements

### Analyzer to Mind Migration Map

```typescript
// packages/migration/src/analyzer-to-mind-map.ts

export const ANALYZER_MIND_MAP = {
  // Legacy Analyzer -> New Mind
  'content-extractor': 'tim',
  'behavior-analyzer': 'daniel',
  'values-extractor': 'brene',
  'cognitive-analyzer': 'barbara',
  'synthesis-engine': 'charlie',
  'implementation-planner': 'constantin',
  'quality-validator': 'quinn',
  'feasibility-checker': 'victoria'
} as const;

export interface MigrationResult {
  success: boolean;
  migratedAnalyzers: string[];
  failedAnalyzers: string[];
  warnings: string[];
  rollbackAvailable: boolean;
}
```

### Migration Manager

```typescript
// packages/migration/src/migration-manager.ts

export class AnalyzerToMindMigration {
  constructor(
    private readonly orchestrator: MindOrchestrator,
    private readonly legacyAnalyzers: LegacyAnalyzerRegistry,
    private readonly configMigrator: ConfigMigrator
  ) {}

  async migrate(options: MigrationOptions): Promise<MigrationResult> {
    const result: MigrationResult = {
      success: true,
      migratedAnalyzers: [],
      failedAnalyzers: [],
      warnings: [],
      rollbackAvailable: true
    };

    // 1. Create backup of current configuration
    await this.createBackup();

    // 2. Validate prerequisites
    const prerequisites = await this.validatePrerequisites();
    if (!prerequisites.valid) {
      return { ...result, success: false, warnings: prerequisites.issues };
    }

    // 3. Migrate each analyzer
    for (const [analyzerId, mindId] of Object.entries(ANALYZER_MIND_MAP)) {
      try {
        await this.migrateAnalyzer(analyzerId, mindId);
        result.migratedAnalyzers.push(analyzerId);
      } catch (error) {
        result.failedAnalyzers.push(analyzerId);
        result.warnings.push(`Failed to migrate ${analyzerId}: ${error.message}`);

        if (options.stopOnError) {
          result.success = false;
          break;
        }
      }
    }

    // 4. Migrate configurations
    await this.configMigrator.migrateAll();

    // 5. Validate migration
    const validation = await this.validateMigration();
    if (!validation.passed) {
      result.success = false;
      result.warnings.push(...validation.issues);
    }

    return result;
  }

  private async migrateAnalyzer(
    analyzerId: string,
    mindId: MindId
  ): Promise<void> {
    // 1. Get legacy analyzer config
    const legacyConfig = await this.legacyAnalyzers.getConfig(analyzerId);

    // 2. Convert to Mind-compatible format
    const mindConfig = this.convertConfig(legacyConfig, mindId);

    // 3. Register with orchestrator
    await this.orchestrator.registerMind(mindId, mindConfig);

    // 4. Create compatibility layer
    await this.createCompatibilityLayer(analyzerId, mindId);
  }

  private convertConfig(
    legacyConfig: LegacyAnalyzerConfig,
    mindId: MindId
  ): MindConfig {
    return {
      mindId,
      enabled: legacyConfig.enabled,
      priority: legacyConfig.priority || 0,
      customPrompts: this.convertPrompts(legacyConfig.prompts),
      thresholds: this.convertThresholds(legacyConfig.thresholds)
    };
  }
}
```

### Compatibility Layer

```typescript
// packages/migration/src/compatibility/legacy-adapter.ts

export class LegacyAnalyzerAdapter {
  constructor(
    private readonly mindId: MindId,
    private readonly orchestrator: MindOrchestrator
  ) {}

  // Provides legacy API that routes to new Minds
  async analyze(content: ExtractedData[]): Promise<LegacyAnalyzerResult> {
    const context: MindContext = {
      extractedData: content,
      sessionId: generateId(),
      options: {}
    };

    const mindResult = await this.orchestrator.analyzeWithMind(
      this.mindId,
      context
    );

    // Convert MindResult to LegacyAnalyzerResult
    return this.convertResult(mindResult);
  }

  private convertResult(result: MindResult): LegacyAnalyzerResult {
    return {
      analyzerId: ANALYZER_MIND_MAP[this.mindId],
      timestamp: new Date().toISOString(),
      data: {
        traits: result.traits,
        confidence: result.confidence,
        evidence: result.evidence
      },
      metadata: result.metadata
    };
  }
}
```

### Feature Flag Integration

```typescript
// packages/migration/src/feature-flags.ts

export const MIGRATION_FLAGS = {
  USE_MINDS_SYSTEM: 'clone-lab-use-minds',
  MIGRATION_MODE: 'clone-lab-migration-mode',
  FALLBACK_ENABLED: 'clone-lab-fallback-enabled'
} as const;

export class MigrationFeatureFlags {
  constructor(private readonly flagProvider: FeatureFlagProvider) {}

  shouldUseMinds(): boolean {
    return this.flagProvider.getBoolean(MIGRATION_FLAGS.USE_MINDS_SYSTEM, false);
  }

  getMigrationMode(): 'full' | 'hybrid' | 'legacy' {
    return this.flagProvider.getString(
      MIGRATION_FLAGS.MIGRATION_MODE,
      'legacy'
    ) as 'full' | 'hybrid' | 'legacy';
  }

  isFallbackEnabled(): boolean {
    return this.flagProvider.getBoolean(
      MIGRATION_FLAGS.FALLBACK_ENABLED,
      true
    );
  }
}
```

---

## Business Value

Esta migracao conecta o novo sistema de Minds ao pipeline existente, permitindo que todo o trabalho das Phases 1-3 seja utilizado em producao.

**Beneficios:**
- Transicao suave sem quebrar funcionalidade existente
- Usuarios nao percebem mudanca durante migracao
- Possibilidade de rollback instantaneo
- Compatibilidade com configuracoes legadas
- Base para futuras melhorias

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Resultados diferentes entre sistemas | Medium | High | Testes de equivalencia extensivos |
| Performance degradada durante migracao | Low | Medium | Feature flags + migracao gradual |
| Configuracoes legadas incompativeis | Medium | Medium | ConfigMigrator com fallbacks |
| Rollback falha | Low | Critical | Backup obrigatorio + testes de rollback |

---

## Scope

### In Scope
- Analyzer to Mind mapping
- MigrationManager class
- LegacyAnalyzerAdapter for compatibility
- Feature flags for gradual rollout
- Configuration migration
- Validation and rollback

### Out of Scope
- UI migration indicators
- Distributed migration
- Real-time migration monitoring

---

## Dependencies

| Dependency | Type | Status |
|------------|------|--------|
| CL2-001 to CL2-011 (Minds) | Package | Pending |
| CL2-010 (Orchestrator) | Package | Pending |
| Clone Lab v1.0 Analyzers | Package | Available |
| Feature Flag System | Runtime | Available |

---

## Dev Notes

### Migration Strategy

```yaml
migration_strategy:
  phases:
    - name: shadow
      description: Minds run in parallel, results compared
      duration: 1 week
    - name: hybrid
      description: 50% traffic to Minds, 50% to legacy
      duration: 1 week
    - name: full
      description: 100% traffic to Minds
      duration: ongoing
  rollback_trigger:
    error_rate_threshold: 5%
    fidelity_drop_threshold: 10%
```

### Validation Criteria

- Fidelity scores within 5% of legacy
- Processing time within 20% of legacy
- No critical errors in production
- All configurations migrated successfully

---

## File List

| File | Action | Status |
|------|--------|--------|
| `packages/migration/src/analyzer-to-mind-map.ts` | Create | Pending |
| `packages/migration/src/migration-manager.ts` | Create | Pending |
| `packages/migration/src/compatibility/legacy-adapter.ts` | Create | Pending |
| `packages/migration/src/feature-flags.ts` | Create | Pending |
| `packages/migration/src/config-migrator.ts` | Create | Pending |
| `packages/migration/src/index.ts` | Create | Pending |
| `packages/migration/src/__tests__/migration.test.ts` | Create | Pending |

---

## Definition of Done

- [ ] All 8 legacy analyzers mapped to Minds
- [ ] MigrationManager executes successfully
- [ ] LegacyAnalyzerAdapter provides compatible API
- [ ] Feature flags control rollout
- [ ] Configurations migrate correctly
- [ ] Validation passes (fidelity within 5%)
- [ ] Rollback tested and works
- [ ] Shadow mode tested
- [ ] Lint passa sem erros
- [ ] Code review aprovado

---

## QA Checklist

- [ ] All 8 analyzers migrated correctly
- [ ] Results equivalent to legacy
- [ ] Feature flags work as expected
- [ ] Rollback restores v1.0 state
- [ ] Configuration migration complete
- [ ] No data loss during migration

---

## Change Log

| Date | Author | Description |
|------|--------|-------------|
| 2026-02-20 | Morgan (PM) | Story created |

---

*Story generated by Morgan (PM Agent) - AIOS Framework*
