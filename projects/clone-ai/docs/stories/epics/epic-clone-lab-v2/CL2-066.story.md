# Story CL2-066: Profile Synthesizer & AIOS Export

**Story ID:** CL2-066
**Epic:** EPIC-CLONE-LAB-V2
**Phase:** 4 - Integration
**Status:** Ready
**Points:** 8
**Author:** River (SM), Aria (Architect)

---

## Description

Criar o **Profile Package** que sintetiza os resultados das 8 Minds em um `CognitiveProfile` estruturado e exporta para formatos consum√≠veis pelo AIOS (Agent Definition e Squad Configuration).

### Problem Statement

As 8 Minds produzem `MindResult[]` com traits especializados por dimens√£o. Para ser √∫til, esses resultados precisam ser:
1. Agregados em um perfil cognitivo unificado
2. Exportados em formatos que o AIOS possa consumir
3. Version√°veis e port√°veis entre projetos

### Contexto Arquitetural

```
ExtractedData ‚Üí [8 Minds Analysis] ‚Üí MindResult[]
                                              ‚Üì
                                    [ProfileSynthesizer]
                                              ‚Üì
                                    CognitiveProfile (YAML)
                                              ‚Üì
                                    [Exporter] ‚Üí AIOS Agent / Squad
```

**8 Minds = MOTOR de an√°lise** (processam dados)
**CognitiveProfile = FORMATO DE SA√çDA** (estrutura de dados)

---

## Acceptance Criteria

```gherkin
Given all 8 minds have produced their results
When the ProfileSynthesizer processes them
Then a complete CognitiveProfile is generated

Given a CognitiveProfile exists
When exported as AIOS Agent
Then a valid .agent.md file is created with correct persona definition

Given a CognitiveProfile exists
When exported as Squad Configuration
Then a valid .yaml squad file is created

Given existing Clone Lab schemas in src/clone-lab/
When this story is complete
Then schemas are moved to packages/profile/schemas/
```

---

## Technical Requirements

### Package Structure

```
packages/profile/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ synthesizer/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ profile-synthesizer.ts    # Aggregates MindResult[] ‚Üí CognitiveProfile
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ trait-mapper.ts           # Maps mind traits to profile fields
‚îÇ   ‚îú‚îÄ‚îÄ schemas/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cognitive-profile.schema.json  # JSON Schema (from Clone Lab)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ types.ts                       # TypeScript types
‚îÇ   ‚îú‚îÄ‚îÄ exporters/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ aios-agent-exporter.ts    # Export to AIOS agent definition
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ squad-config-exporter.ts  # Export to squad configuration
‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îú‚îÄ‚îÄ package.json
‚îî‚îÄ‚îÄ tsconfig.json
```

### ProfileSynthesizer

```typescript
// packages/profile/src/synthesizer/profile-synthesizer.ts

import type { MindResult, MindId } from '@clone-lab/minds';
import type { CognitiveProfile } from '../schemas/types.js';

export interface SynthesizerConfig {
  confidenceThreshold: number;    // Minimum confidence to include trait
  includeEvidence: boolean;       // Include supporting evidence
  version: string;                // Profile version
}

export class ProfileSynthesizer {
  constructor(private config: SynthesizerConfig) {}

  /**
   * Synthesize results from all 8 minds into a unified cognitive profile
   */
  synthesize(
    results: Map<MindId, MindResult>,
    identity: ProfileIdentity
  ): CognitiveProfile {
    return {
      id: this.generateId(identity),
      version: this.config.version,
      created: new Date().toISOString().split('T')[0],
      updated: new Date().toISOString().split('T')[0],

      identity,

      cognitive_profile: this.buildCognitiveProfile(results),

      knowledge_base: this.buildKnowledgeBase(results),

      communication_patterns: this.buildCommunicationPatterns(results),

      decision_frameworks: this.buildDecisionFrameworks(results),

      behavioral_patterns: this.buildBehavioralPatterns(results),

      values_and_principles: this.buildValues(results),

      context_examples: this.extractExamples(results),

      metadata: {
        capture_methods: ['8-minds-analysis'],
        confidence_score: this.calculateOverallConfidence(results),
        validation_status: 'synthesized',
        source_minds: Array.from(results.keys()),
      },
    };
  }

  /**
   * Map Daniel's behavioral analysis to cognitive_profile
   */
  private buildCognitiveProfile(results: Map<MindId, MindResult>): CognitiveProfileSection {
    const danielResult = results.get('daniel');
    const barbaraResult = results.get('barbara');

    return {
      // Extract MBTI from Barbara's cognitive analysis
      mbti: this.extractMBTI(barbaraResult),
      // Extract Big Five from Daniel's behavioral analysis
      big_five: this.extractBigFive(danielResult),
      decision_style: this.inferDecisionStyle(results),
      communication_style: this.inferCommunicationStyle(results),
      // ... other fields
    };
  }

  /**
   * Map Tim's extraction to knowledge_base.domains
   */
  private buildKnowledgeBase(results: Map<MindId, MindResult>): KnowledgeBase {
    const timResult = results.get('tim');
    const charlieResult = results.get('charlie');

    return {
      domains: this.extractDomains(timResult),
      heuristics: this.extractHeuristics(results),
      mental_models: this.extractMentalModels(charlieResult),
    };
  }

  /**
   * Map Brene's values analysis to values_and_principles
   */
  private buildValues(results: Map<MindId, MindResult>): ValuesAndPrinciples {
    const breneResult = results.get('brene');

    return {
      core_values: this.extractCoreValues(breneResult),
      non_negotiables: this.extractNonNegotiables(breneResult),
      trade_off_preferences: this.extractTradeoffs(results),
    };
  }
}
```

### AIOS Agent Exporter

```typescript
// packages/profile/src/exporters/aios-agent-exporter.ts

import type { CognitiveProfile } from '../schemas/types.js';

export class AIOSAgentExporter {
  /**
   * Export CognitiveProfile to AIOS Agent Definition format
   */
  export(profile: CognitiveProfile): string {
    return `# clone-${profile.identity.alias}

ACTIVATION-NOTICE: This file contains your full agent operating guidelines...

\`\`\`yaml
agent:
  name: "${profile.identity.name} Clone"
  id: "clone-${profile.identity.alias}"
  title: "${profile.identity.role} Mental Clone"
  icon: "üß†"
  source_profile: "packages/profiles/clone-${profile.identity.alias}-v${profile.version}.yaml"

persona_profile:
  archetype: "Mirror"
  communication:
    tone: "${profile.communication_patterns?.tone || 'professional'}"
    vocabulary: ${JSON.stringify(profile.communication_patterns?.vocabulary || [])}

persona:
  role: "Mental Clone of ${profile.identity.name}"
  style: "${profile.cognitive_profile?.communication_style}, ${profile.cognitive_profile?.decision_style}"
  identity: |
    I am a mental clone of ${profile.identity.name}, ${profile.identity.role}.
    I think, decide, and communicate as ${profile.identity.name} would.

  core_principles:
${this.formatHeuristicsAsPrinciples(profile.knowledge_base?.heuristics || [])}

commands:
  - name: profile
    description: "Show my cognitive profile details"
  - name: think
    description: "Work through a problem as ${profile.identity.name} would"
  - name: decide
    description: "Help make decisions using ${profile.identity.name}'s frameworks"
\`\`\`
`;
  }
}
```

### Trait Mapper

```typescript
// packages/profile/src/synthesizer/trait-mapper.ts

/**
 * Maps traits from each Mind to CognitiveProfile fields
 */
export const TRAIT_MAPPINGS: TraitMapping = {
  // Tim (Extraction) ‚Üí knowledge_base.domains
  tim: {
    'expertise-area': 'knowledge_base.domains',
    'source-quality': 'metadata.source_quality',
  },

  // Daniel (Behavioral) ‚Üí cognitive_profile.big_five, behavioral_patterns
  daniel: {
    'behavioral-pattern': 'behavioral_patterns',
    'cognitive-bias': 'cognitive_profile.cognitive_biases',
    'big-five-trait': 'cognitive_profile.big_five',
  },

  // Brene (Values) ‚Üí values_and_principles
  brene: {
    'core-value': 'values_and_principles.core_values',
    'belief': 'values_and_principles.beliefs',
    'vulnerability': 'behavioral_patterns.vulnerabilities',
  },

  // Barbara (Cognitive) ‚Üí cognitive_profile.mbti, mental_models
  barbara: {
    'thinking-style': 'cognitive_profile.thinking_style',
    'mbti-indicator': 'cognitive_profile.mbti',
    'learning-preference': 'cognitive_profile.learning_preference',
  },

  // Charlie (Synthesis) ‚Üí mental_models, decision_frameworks
  charlie: {
    'mental-model': 'knowledge_base.mental_models',
    'paradox': 'decision_frameworks.paradoxes',
    'synthesis': 'decision_frameworks.synthesis',
  },

  // Constantin (Implementation) ‚Üí decision_frameworks
  constantin: {
    'implementation-pattern': 'decision_frameworks.implementation',
    'technical-preference': 'knowledge_base.domains.technical',
  },

  // Quinn (QA) ‚Üí heuristics (validation rules)
  quinn: {
    'quality-heuristic': 'knowledge_base.heuristics',
    'validation-rule': 'knowledge_base.heuristics',
  },

  // Victoria (Feasibility) ‚Üí decision_frameworks.trade_offs
  victoria: {
    'trade-off': 'values_and_principles.trade_off_preferences',
    'feasibility-constraint': 'decision_frameworks.constraints',
  },
};
```

---

## Business Value

Esta story **fecha o ciclo** do Clone Lab v2.0:
- 8 Minds ANALISAM dados
- ProfileSynthesizer AGREGA resultados
- Exporters PRODUZEM artefatos √∫teis

**Benef√≠cios:**
- Perfis cognitivos port√°veis entre projetos AIOS
- Agentes personalizados a partir de an√°lise real
- Squad configurations com clones de especialistas
- Base para marketplace de perfis no futuro

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Schemas do Clone Lab incompat√≠veis com MindResult | Medium | High | Validar mapeamento com testes |
| Perda de informa√ß√£o na s√≠ntese | Medium | Medium | Confidence scores + evid√™ncia |
| Export quebrando templates AIOS | Low | High | Validar outputs com @aios-master |
| Depend√™ncia de CL2-010 (Orchestrator) | High | High | Orchestrator deve estar Done |

---

## Scope

### In Scope
- Novo package `@clone-lab/profile`
- ProfileSynthesizer class
- TraitMapper para mapear Minds ‚Üí Profile
- AIOSAgentExporter
- SquadConfigExporter
- Mover schemas de src/clone-lab/ para packages/profile/schemas/
- TypeScript types para CognitiveProfile
- Unit tests

### Out of Scope
- CLI commands (CL2-047 a CL2-049)
- Interview protocol (manter em docs/)
- Web UI

---

## Dependencies

| Dependency | Type | Status |
|------------|------|--------|
| CL2-001 (IMind Interface) | Package | Done |
| CL2-002 to CL2-009 (8 Minds) | Package | Pending |
| CL2-010 (Orchestrator) | Package | Ready |
| @clone-lab/core | Package | Available |
| js-yaml | npm | To install |

---

## Dev Notes

### Mapeamento Minds ‚Üí Profile

| Mind | Profile Field |
|------|---------------|
| **Tim** | `knowledge_base.domains` |
| **Daniel** | `cognitive_profile.big_five`, `behavioral_patterns` |
| **Brene** | `values_and_principles.core_values` |
| **Barbara** | `cognitive_profile.mbti`, `cognitive_profile.thinking_style` |
| **Charlie** | `knowledge_base.mental_models`, `decision_frameworks` |
| **Constantin** | `decision_frameworks.implementation` |
| **Quinn** | `knowledge_base.heuristics` (validation rules) |
| **Victoria** | `values_and_principles.trade_off_preferences` |

### Arquivos Existentes para Migrar

| De | Para |
|----|-----|
| `src/clone-lab/schemas/cognitive-profile.schema.json` | `packages/profile/schemas/` |
| `src/clone-lab/schemas/cognitive-profile.example.yaml` | `packages/profile/examples/` |
| `src/clone-lab/templates/clone-agent-template.md` | `packages/profile/templates/` |
| `src/clone-lab/scripts/profile-to-agent-converter.ts` | Refatorar em `exporters/aios-agent-exporter.ts` |
| `src/clone-lab/protocols/interview-protocol.yaml` | `docs/protocols/` (manter como doc) |

### Testing
- Testar s√≠ntese com mocks de MindResult
- Validar export contra schema AIOS
- Integration test com Orchestrator

---

## File List

| File | Action | Status |
|------|--------|--------|
| `packages/profile/package.json` | Create | Pending |
| `packages/profile/tsconfig.json` | Create | Pending |
| `packages/profile/src/index.ts` | Create | Pending |
| `packages/profile/src/synthesizer/profile-synthesizer.ts` | Create | Pending |
| `packages/profile/src/synthesizer/trait-mapper.ts` | Create | Pending |
| `packages/profile/src/schemas/cognitive-profile.schema.json` | Move | Pending |
| `packages/profile/src/schemas/types.ts` | Create | Pending |
| `packages/profile/src/exporters/aios-agent-exporter.ts` | Create | Pending |
| `packages/profile/src/exporters/squad-config-exporter.ts` | Create | Pending |
| `packages/profile/__tests__/synthesizer.test.ts` | Create | Pending |
| `package.json` (root) | Update workspace | Pending |

---

## Definition of Done

- [ ] Package `@clone-lab/profile` criado e compilando
- [ ] ProfileSynthesizer agrega MindResult[] ‚Üí CognitiveProfile
- [ ] TraitMapper mapeia corretamente cada Mind
- [ ] AIOSAgentExporter gera .agent.md v√°lido
- [ ] SquadConfigExporter gera .yaml v√°lido
- [ ] Schemas migrados de src/clone-lab/
- [ ] Unit tests passando
- [ ] Lint passa sem erros
- [ ] Build do monorepo passa
- [ ] Code review aprovado

---

## QA Checklist

- [ ] ProfileSynthesizer produces valid CognitiveProfile
- [ ] All 8 Minds are mapped correctly
- [ ] Exported AIOS agent is valid
- [ ] Exported squad config is valid
- [ ] No information loss in synthesis
- [ ] Confidence scores calculated correctly
- [ ] All tests pass

---

## Change Log

| Date | Author | Description |
|------|--------|-------------|
| 2026-02-20 | River (SM) | Story created based on @architect analysis |
| 2026-02-20 | Aria (Architect) | Architecture review and requirements |
| 2026-02-20 | Pax (PO) | Validation: GO (10/10). Status: Draft ‚Üí Ready |

---

*Story generated by River (SM Agent) - AIOS Framework*
