# Story CL2-030: Self-Assessment Engine

**Story ID:** CL2-030
**Epic:** EPIC-CLONE-LAB-V2
**Phase:** 3 - Meta-Cognition
**Status:** Ready
**Points:** 8
**Author:** Morgan (PM)

---

## Description

Implementar o **Self-Assessment Engine** - componente central de meta-cognição que avalia a saúde, performance e qualidade do sistema Clone Lab, gerando scores e identificando áreas de melhoria.

### Problem Statement
O Clone Lab precisa ser capaz de avaliar a si mesmo para identificar oportunidades de melhoria. O Self-Assessment Engine analisa métricas, logs e resultados para gerar uma avaliação completa do sistema.

---

## Acceptance Criteria

```gherkin
Given the system has been running for some time
When self-assessment is triggered
Then a comprehensive assessment report is generated

Given metrics show declining fidelity scores
When assessment runs
Then the trend is identified and flagged

Given multiple components have issues
When assessment prioritizes issues
Then issues are ranked by impact and urgency

Given an assessment is complete
When results are requested
Then actionable recommendations are provided
```

---

## Technical Requirements

### Self-Assessment Engine

```typescript
// packages/meta/src/assessment/engine.ts

export interface SelfAssessmentResult {
  id: string;
  timestamp: Date;
  overallScore: number;          // 0-100
  categories: AssessmentCategory[];
  trends: TrendAnalysis[];
  issues: IdentifiedIssue[];
  recommendations: Recommendation[];
  comparison: HistoricalComparison | null;
}

export interface AssessmentCategory {
  name: string;
  score: number;
  weight: number;
  components: ComponentScore[];
  trend: 'improving' | 'stable' | 'declining';
}

export interface ComponentScore {
  name: string;
  score: number;
  contribution: number;           // Contribution to category score
  details: Record<string, unknown>;
}

export class SelfAssessmentEngine {
  private readonly metricsCollector: MetricsCollector;
  private readonly assessors: Map<string, CategoryAssessor>;

  constructor(
    metricsCollector: MetricsCollector,
    config: AssessmentConfig
  ) {
    this.metricsCollector = metricsCollector;
    this.assessors = new Map();
    this.registerDefaultAssessors();
  }

  async assess(): Promise<SelfAssessmentResult> {
    const categories: AssessmentCategory[] = [];
    const issues: IdentifiedIssue[] = [];

    // Run each category assessor
    for (const [name, assessor] of this.assessors) {
      const result = await assessor.assess(this.metricsCollector);
      categories.push(result.category);
      issues.push(...result.issues);
    }

    // Calculate overall score (weighted average)
    const overallScore = this.calculateOverallScore(categories);

    // Analyze trends
    const trends = await this.analyzeTrends(categories);

    // Generate recommendations
    const recommendations = this.generateRecommendations(issues, trends);

    // Compare with previous assessment
    const comparison = await this.getHistoricalComparison();

    return {
      id: generateId(),
      timestamp: new Date(),
      overallScore,
      categories,
      trends,
      issues: this.prioritizeIssues(issues),
      recommendations,
      comparison
    };
  }

  private registerDefaultAssessors(): void {
    this.assessors.set('clone_quality', new CloneQualityAssessor());
    this.assessors.set('mind_performance', new MindPerformanceAssessor());
    this.assessors.set('validation_coverage', new ValidationCoverageAssessor());
    this.assessors.set('checkpoint_efficiency', new CheckpointEfficiencyAssessor());
    this.assessors.set('system_health', new SystemHealthAssessor());
  }

  private calculateOverallScore(categories: AssessmentCategory[]): number {
    const totalWeight = categories.reduce((sum, c) => sum + c.weight, 0);
    const weightedSum = categories.reduce(
      (sum, c) => sum + c.score * c.weight,
      0
    );
    return Math.round(weightedSum / totalWeight);
  }
}
```

### Category Assessors

```typescript
// packages/meta/src/assessment/assessors/clone-quality.ts

export class CloneQualityAssessor implements CategoryAssessor {
  readonly name = 'clone_quality';
  readonly weight = 0.30;  // 30% of overall score

  async assess(metrics: MetricsCollector): Promise<AssessorResult> {
    const components: ComponentScore[] = [];
    const issues: IdentifiedIssue[] = [];

    // Fidelity Score
    const fidelityMetrics = await metrics.getAggregated(
      'clone_fidelity_score',
      { start: daysAgo(30), end: now() },
      'avg'
    );
    const fidelityScore = this.calculateFidelityScore(fidelityMetrics);
    components.push({
      name: 'fidelity',
      score: fidelityScore,
      contribution: 0.5,
      details: { avgFidelity: fidelityScore }
    });

    // Success Rate
    const successMetrics = await metrics.getAggregated(
      'clone_operations_total',
      { start: daysAgo(30), end: now() },
      'count'
    );
    const successRate = this.calculateSuccessRate(successMetrics);
    components.push({
      name: 'success_rate',
      score: successRate,
      contribution: 0.3,
      details: { rate: successRate }
    });

    // Consistency
    const consistencyScore = await this.assessConsistency(metrics);
    components.push({
      name: 'consistency',
      score: consistencyScore,
      contribution: 0.2,
      details: {}
    });

    // Identify issues
    if (fidelityScore < 70) {
      issues.push({
        id: 'low-fidelity',
        severity: 'high',
        category: 'clone_quality',
        description: `Clone fidelity is below target: ${fidelityScore}%`,
        impact: 'User clones may not accurately represent source'
      });
    }

    const categoryScore = this.aggregateComponents(components);
    const trend = await this.calculateTrend(metrics, 'clone_quality');

    return {
      category: {
        name: this.name,
        score: categoryScore,
        weight: this.weight,
        components,
        trend
      },
      issues
    };
  }
}
```

### Trend Analysis

```typescript
// packages/meta/src/assessment/trends.ts

export class TrendAnalyzer {
  async analyze(
    metrics: MetricsCollector,
    category: string,
    days: number = 30
  ): Promise<TrendAnalysis> {
    const dataPoints = await this.getDataPoints(metrics, category, days);

    if (dataPoints.length < 3) {
      return { direction: 'insufficient_data', confidence: 0 };
    }

    // Simple linear regression
    const regression = this.linearRegression(dataPoints);

    // Calculate trend direction
    const slope = regression.slope;
    const direction = this.classifyTrend(slope);

    // Calculate confidence
    const r2 = regression.r2;
    const confidence = Math.round(r2 * 100);

    return {
      direction,
      confidence,
      slope,
      projectedChange: this.projectChange(slope, 7) // 7 days projection
    };
  }

  private classifyTrend(slope: number): 'improving' | 'stable' | 'declining' {
    if (slope > 0.5) return 'improving';
    if (slope < -0.5) return 'declining';
    return 'stable';
  }
}
```

### Recommendations Generator

```typescript
// packages/meta/src/assessment/recommendations.ts

export class RecommendationsGenerator {
  generate(issues: IdentifiedIssue[], trends: TrendAnalysis[]): Recommendation[] {
    const recommendations: Recommendation[] = [];

    for (const issue of issues) {
      const recommendation = this.createRecommendation(issue);
      if (recommendation) {
        recommendations.push(recommendation);
      }
    }

    // Add trend-based recommendations
    for (const trend of trends) {
      if (trend.direction === 'declining' && trend.confidence > 70) {
        recommendations.push(this.createTrendRecommendation(trend));
      }
    }

    return this.prioritize(recommendations);
  }

  private createRecommendation(issue: IdentifiedIssue): Recommendation | null {
    const templates: Record<string, RecommendationTemplate> = {
      'low-fidelity': {
        title: 'Review Mind Prompts',
        description: 'Analyze and optimize prompts for minds with low fidelity scores',
        actions: [
          'Run mind analysis comparison',
          'Review prompt templates',
          'Consider prompt engineering improvements'
        ],
        impact: 'high',
        effort: 'medium'
      },
      'high-bottleneck': {
        title: 'Optimize Bottlenecked Component',
        description: 'Address performance bottleneck in identified component',
        actions: [
          'Profile component execution',
          'Identify slow operations',
          'Consider caching or parallelization'
        ],
        impact: 'medium',
        effort: 'medium'
      }
    };

    const template = templates[issue.id];
    if (!template) return null;

    return {
      id: `rec-${issue.id}`,
      title: template.title,
      description: template.description,
      relatedIssue: issue.id,
      actions: template.actions,
      impact: template.impact,
      effort: template.effort,
      priority: this.calculatePriority(issue, template)
    };
  }
}
```

---

## Business Value

O Self-Assessment Engine é o **cérebro da meta-cognição** - permite que o sistema entenda sua própria performance e identifique oportunidades de melhoria.

**Benefícios:**
- Visibilidade completa da saúde do sistema
- Identificação proativa de problemas
- Base para auto-improvement
- Dashboard de qualidade para stakeholders

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Assessment too slow | Medium | Medium | Async execution + caching |
| False positives in issues | Medium | Low | Confidence thresholds |
| Trend analysis inaccurate | Low | Medium | Require more data points |

---

## Scope

### In Scope
- SelfAssessmentEngine class
- 5 category assessors (clone quality, mind performance, validation, checkpoints, health)
- Trend analysis
- Recommendations generator
- Historical comparison

### Out of Scope
- ML-based predictions
- Real-time assessment
- Distributed assessment

---

## Dependencies

| Dependency | Type | Status |
|------------|------|--------|
| CL2-028 (Meta Package Setup) | Package | Pending |
| CL2-029 (Metrics Collector) | Package | Pending |
| @clone-lab/core | Package | Available |

---

## Dev Notes

### Assessment Categories & Weights

| Category | Weight | Description |
|----------|--------|-------------|
| Clone Quality | 30% | Fidelity, success rate, consistency |
| Mind Performance | 25% | Speed, confidence, accuracy |
| Validation Coverage | 20% | Task execution, coverage, effectiveness |
| Checkpoint Efficiency | 15% | Review speed, approval rate |
| System Health | 10% | Bottlenecks, errors, resource usage |

### Assessment Schedule

```yaml
assessment:
  full: weekly      # Complete assessment
  quick: daily      # Key metrics only
  trigger: on_demand # Manual trigger
```

---

## File List

| File | Action | Status |
|------|--------|--------|
| `packages/meta/src/assessment/engine.ts` | Create | Pending |
| `packages/meta/src/assessment/assessors/clone-quality.ts` | Create | Pending |
| `packages/meta/src/assessment/assessors/mind-performance.ts` | Create | Pending |
| `packages/meta/src/assessment/assessors/validation-coverage.ts` | Create | Pending |
| `packages/meta/src/assessment/assessors/checkpoint-efficiency.ts` | Create | Pending |
| `packages/meta/src/assessment/assessors/system-health.ts` | Create | Pending |
| `packages/meta/src/assessment/trends.ts` | Create | Pending |
| `packages/meta/src/assessment/recommendations.ts` | Create | Pending |
| `packages/meta/src/assessment/index.ts` | Create | Pending |
| `packages/meta/src/assessment/__tests__/engine.test.ts` | Create | Pending |

---

## Definition of Done

- [ ] Assessment engine runs all category assessors
- [ ] Overall score calculated correctly
- [ ] Trends analyzed accurately
- [ ] Recommendations generated for issues
- [ ] Historical comparison works
- [ ] Assessment completes in < 30 seconds
- [ ] Lint passa sem erros
- [ ] Code review aprovado

---

## QA Checklist

- [ ] Assessment engine runs all category assessors
- [ ] Overall score calculated correctly
- [ ] Trends analyzed accurately
- [ ] Recommendations generated for issues
- [ ] Historical comparison works
- [ ] Assessment completes in < 30 seconds
- [ ] All tests pass

---

## Change Log

| Date | Author | Description |
|------|--------|-------------|
| 2026-02-20 | Morgan (PM) | Story created |

---

*Story generated by Morgan (PM Agent) - AIOS Framework*
