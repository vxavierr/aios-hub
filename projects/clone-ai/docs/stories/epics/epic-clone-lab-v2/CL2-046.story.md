# Story CL2-046: Manifest Generator Enhancement

**Story ID:** CL2-046
**Epic:** EPIC-CLONE-LAB-V2
**Phase:** 4 - Integration
**Status:** Ready
**Points:** 5
**Author:** Morgan (PM)

---

## Description

Aprimorar o Manifest Generator para usar o DNA v2.0 enriquecido e gerar manifests mais detalhados e precisos. O generator deve criar prompts de sistema otimizados baseados em todas as dimensoes analisadas pelas 8 Minds.

### Problem Statement
O Manifest Generator atual usa DNA basico. Com o DNA v2.0 enriquecido pelas 8 Minds, o generator pode criar manifests de sistema muito mais precisos e personalizados.

---

## Acceptance Criteria

```gherkin
Given a DNA v2.0 profile is available
When Manifest Generator processes it
Then a comprehensive system prompt is generated

Given DNA has high confidence in communication style
When generating manifest
Then the communication instructions are emphasized

Given DNA has low confidence in some areas
When generating manifest
Then appropriate hedging is included

Given a manifest is generated
When validated against schema
Then all required sections are present and well-formed
```

---

## Technical Requirements

### Enhanced Manifest Generator

```typescript
// packages/manifest/src/generator/enhanced-generator.ts

export class EnhancedManifestGenerator {
  constructor(
    private readonly templateEngine: TemplateEngine,
    private readonly emphasisCalculator: EmphasisCalculator,
    private readonly manifestValidator: ManifestValidator
  ) {}

  async generate(dna: DNAProfileV2): Promise<SystemManifest> {
    // 1. Analyze DNA structure
    const analysis = this.analyzeDNA(dna);

    // 2. Calculate emphasis weights
    const emphasis = this.emphasisCalculator.calculate(dna);

    // 3. Generate each section
    const sections = await this.generateSections(dna, emphasis);

    // 4. Assemble manifest
    const manifest = this.assembleManifest(sections, dna);

    // 5. Validate
    const validation = await this.manifestValidator.validate(manifest);
    if (!validation.valid) {
      throw new ManifestGenerationError(validation.issues);
    }

    return manifest;
  }

  private async generateSections(
    dna: DNAProfileV2,
    emphasis: EmphasisWeights
  ): Promise<ManifestSections> {
    return {
      identity: await this.generateIdentitySection(dna),
      communication: await this.generateCommunicationSection(dna, emphasis),
      behavioral: await this.generateBehavioralSection(dna, emphasis),
      cognitive: await this.generateCognitiveSection(dna, emphasis),
      values: await this.generateValuesSection(dna, emphasis),
      implementation: await this.generateImplementationSection(dna, emphasis),
      constraints: await this.generateConstraintsSection(dna),
      examples: await this.generateExamplesSection(dna)
    };
  }

  private async generateCommunicationSection(
    dna: DNAProfileV2,
    emphasis: EmphasisWeights
  ): Promise<string> {
    const comm = dna.traits.communication;
    const confidence = comm.confidence;

    let section = `## Communication Style\n\n`;

    if (confidence > 0.8) {
      section += `You communicate with a ${comm.style} style.\n`;
      section += `Your tone is ${comm.tone} and your formality level is ${comm.formality}.\n`;
    } else if (confidence > 0.5) {
      section += `You tend to communicate with a ${comm.style} style, `;
      section += `typically using a ${comm.tone} tone.\n`;
    } else {
      section += `When communicating, you may use a ${comm.style} approach.\n`;
    }

    // Add specific patterns if emphasis is high
    if (emphasis.communication > 0.7) {
      section += `\n**Key communication patterns:**\n`;
      section += this.generateCommunicationPatterns(comm);
    }

    return section;
  }
}
```

### Emphasis Calculator

```typescript
// packages/manifest/src/generator/emphasis-calculator.ts

export class EmphasisCalculator {
  calculate(dna: DNAProfileV2): EmphasisWeights {
    const weights: EmphasisWeights = {
      communication: 0,
      behavioral: 0,
      cognitive: 0,
      values: 0,
      implementation: 0
    };

    // Base weight from confidence
    for (const [category, traits] of Object.entries(dna.traits)) {
      weights[category] = traits.confidence;
    }

    // Boost categories with rich data
    for (const [category, traits] of Object.entries(dna.traits)) {
      const richness = this.calculateRichness(traits);
      weights[category] *= (1 + richness * 0.5);
    }

    // Normalize to sum to 1.0
    const total = Object.values(weights).reduce((a, b) => a + b, 0);
    for (const key of Object.keys(weights)) {
      weights[key] /= total;
    }

    return weights;
  }

  private calculateRichness(traits: any): number {
    let score = 0;
    const maxScore = 10;

    // Count populated fields
    const fields = Object.keys(traits).filter(k => traits[k] !== undefined);
    score += fields.length / maxScore;

    // Count nested depth
    const depth = this.measureDepth(traits);
    score += Math.min(depth / 3, 1);

    return score / 2;
  }
}
```

### Manifest Template Engine

```typescript
// packages/manifest/src/generator/template-engine.ts

export class TemplateEngine {
  private readonly templates: Map<string, string>;

  constructor() {
    this.templates = new Map();
    this.loadTemplates();
  }

  render(templateName: string, context: TemplateContext): string {
    const template = this.templates.get(templateName);
    if (!template) {
      throw new Error(`Template not found: ${templateName}`);
    }

    return this.interpolate(template, context);
  }

  private interpolate(template: string, context: TemplateContext): string {
    return template.replace(/\{\{(\w+)\}\}/g, (_, key) => {
      return context[key]?.toString() ?? '';
    });
  }

  private loadTemplates(): void {
    this.templates.set('identity', IDENTITY_TEMPLATE);
    this.templates.set('communication', COMMUNICATION_TEMPLATE);
    this.templates.set('behavioral', BEHAVIORAL_TEMPLATE);
    // ... more templates
  }
}

const IDENTITY_TEMPLATE = `
## Identity

You are {{name}}, {{roleDescription}}.

Your core characteristics include:
{{#each coreTraits}}
- {{this}}
{{/each}}
`;
```

---

## Business Value

O Manifest Generator aprimorado cria prompts de sistema muito mais precisos e personalizados, resultando em clones de maior fidelidade.

**Beneficios:**
- Prompts de sistema mais precisos
- Enfase proporcional a confidence
- Seções ricas em detalhes
- Hedging automatico para areas incertas
- Base para alta fidelidade de clones

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Manifest muito longo | Medium | Low | Seção de resumo opcional |
| Hedging excessivo | Low | Medium | Limite de hedging por seção |
| Templates incompativeis | Low | Medium | Validacao de template |
| Performance com DNA complexo | Low | Low | Cache de templates |

---

## Scope

### In Scope
- EnhancedManifestGenerator class
- EmphasisCalculator
- TemplateEngine enhancement
- Confidence-based hedging
- Manifest v2.0 schema

### Out of Scope
- Manifest preview UI
- Manifest comparison tools
- Multi-model manifest variants

---

## Dependencies

| Dependency | Type | Status |
|------------|------|--------|
| CL2-045 (DNA Synthesizer) | Package | Pending |
| DNA v2.0 Schema | Schema | Pending |
| Manifest Package v1.0 | Package | Available |
| Template Engine | Internal | Available |

---

## Dev Notes

### Manifest v2.0 Structure

```markdown
# System Prompt for {{name}}

## Identity
[Based on DNA identity]

## Communication Style
[Emphasis-weighted communication]

## Behavioral Patterns
[High-confidence behaviors]

## Cognitive Approach
[Decision-making style]

## Values & Principles
[Core values with confidence]

## Implementation Style
[Work patterns]

## Constraints
[Hard limits and boundaries]

## Examples
[Representative exchanges]
```

---

## File List

| File | Action | Status |
|------|--------|--------|
| `packages/manifest/src/generator/enhanced-generator.ts` | Create | Pending |
| `packages/manifest/src/generator/emphasis-calculator.ts` | Create | Pending |
| `packages/manifest/src/generator/template-engine.ts` | Modify | Pending |
| `packages/manifest/src/generator/types.ts` | Create | Pending |
| `packages/manifest/src/templates/v2/` | Create | Pending |
| `packages/manifest/src/__tests__/generator.test.ts` | Create | Pending |

---

## Definition of Done

- [ ] EnhancedManifestGenerator uses DNA v2.0
- [ ] EmphasisCalculator weights correctly
- [ ] TemplateEngine supports v2.0 templates
- [ ] Confidence-based hedging works
- [ ] Manifest v2.0 schema validated
- [ ] Generated manifests improve fidelity
- [ ] Lint passa sem erros
- [ ] Code review aprovado

---

## QA Checklist

- [ ] Manifests generated from DNA v2.0
- [ ] Emphasis calculated correctly
- [ ] Hedging applied appropriately
- [ ] All sections present
- [ ] Schema validation passes
- [ ] Fidelity improvement measurable

---

## Change Log

| Date | Author | Description |
|------|--------|-------------|
| 2026-02-20 | Morgan (PM) | Story created |

---

*Story generated by Morgan (PM Agent) - AIOS Framework*
