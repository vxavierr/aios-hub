# Story CL2-065: Performance Benchmarking

**Story ID:** CL2-065
**Epic:** EPIC-CLONE-LAB-V2
**Phase:** 5 - Self-Evolution
**Status:** Ready
**Points:** 5
**Author:** Morgan (PM)

---

## Description

Implementar **Performance Benchmarking** - sistema de benchmarks que mede e rastreia a performance do Clone Lab ao longo do tempo, garantindo que melhorias não degradem performance.

---

## Acceptance Criteria

```gherkin
Given benchmarks are defined
When they are executed
Then performance metrics are captured

Given a change is applied
When benchmarks run after
Then performance comparison is available

Given performance degrades
When threshold is crossed
Then alert is triggered
```

---

## Technical Requirements

### Benchmark Suite

```typescript
// packages/meta/src/benchmarks/suite.ts

export interface BenchmarkResult {
  name: string;
  iterations: number;
  totalTime: number;
  avgTime: number;
  minTime: number;
  maxTime: number;
  p50: number;
  p95: number;
  p99: number;
  memory: {
    heapUsed: number;
    heapTotal: number;
    external: number;
  };
}

export class BenchmarkSuite {
  private readonly benchmarks: Map<string, Benchmark>;

  register(name: string, benchmark: Benchmark): void {
    this.benchmarks.set(name, benchmark);
  }

  async runAll(): Promise<BenchmarkReport> {
    const results: BenchmarkResult[] = [];

    for (const [name, benchmark] of this.benchmarks) {
      const result = await this.runBenchmark(name, benchmark);
      results.push(result);
    }

    return {
      timestamp: new Date(),
      results,
      comparison: await this.compareWithBaseline(results)
    };
  }

  private async runBenchmark(name: string, benchmark: Benchmark): Promise<BenchmarkResult> {
    const times: number[] = [];
    const iterations = benchmark.iterations || 100;

    // Warmup
    for (let i = 0; i < 10; i++) {
      await benchmark.run();
    }

    // Measure
    const startMemory = process.memoryUsage();

    for (let i = 0; i < iterations; i++) {
      const start = performance.now();
      await benchmark.run();
      const end = performance.now();
      times.push(end - start);
    }

    const endMemory = process.memoryUsage();

    times.sort((a, b) => a - b);

    return {
      name,
      iterations,
      totalTime: times.reduce((a, b) => a + b, 0),
      avgTime: times.reduce((a, b) => a + b, 0) / iterations,
      minTime: times[0],
      maxTime: times[times.length - 1],
      p50: times[Math.floor(iterations * 0.5)],
      p95: times[Math.floor(iterations * 0.95)],
      p99: times[Math.floor(iterations * 0.99)],
      memory: {
        heapUsed: endMemory.heapUsed - startMemory.heapUsed,
        heapTotal: endMemory.heapTotal,
        external: endMemory.external
      }
    };
  }
}
```

### Clone Lab Benchmarks

```typescript
// packages/meta/src/benchmarks/clone-lab-benchmarks.ts

export const CLONE_LAB_BENCHMARKS: Benchmark[] = [
  {
    name: 'mind-analysis-tim',
    description: 'Tim Mind analysis performance',
    iterations: 50,
    run: async () => {
      const context = createTestContext(100); // 100 sources
      await timMind.analyze(context);
    }
  },
  {
    name: 'mind-analysis-full-pipeline',
    description: 'All 8 Minds execution',
    iterations: 10,
    run: async () => {
      const context = createTestContext(50);
      await orchestrator.execute(context.extractedData);
    }
  },
  {
    name: 'validation-tasks-extraction',
    description: '10 extraction validation tasks',
    iterations: 100,
    run: async () => {
      const context = createTaskContext(10);
      for (let i = 1; i <= 10; i++) {
        await taskRegistry.execute(`EX-00${i}`, context);
      }
    }
  },
  {
    name: 'validation-tasks-all',
    description: 'All 63 validation tasks',
    iterations: 10,
    run: async () => {
      const context = createTaskContext(20);
      await taskExecutor.executeAll(context);
    }
  },
  {
    name: 'dna-synthesis',
    description: 'DNA profile generation',
    iterations: 50,
    run: async () => {
      const mindResults = createMockMindResults();
      await dnaSynthesizer.synthesize(mindResults);
    }
  },
  {
    name: 'manifest-generation',
    description: 'Manifest file generation',
    iterations: 100,
    run: async () => {
      const dna = createMockDNA();
      await manifestGenerator.generate(dna, 'claude');
    }
  },
  {
    name: 'evolution-cycle',
    description: 'Complete improvement cycle',
    iterations: 10,
    run: async () => {
      await autoImprovementEngine.runImprovementCycle();
    }
  },
  {
    name: 'health-check',
    description: 'System health check',
    iterations: 100,
    run: async () => {
      await healthMonitor.checkHealth();
    }
  }
];
```

### Performance Thresholds

```typescript
// packages/meta/src/benchmarks/thresholds.ts

export const PERFORMANCE_THRESHOLDS: Record<string, PerformanceThreshold> = {
  'mind-analysis-tim': {
    maxAvgTime: 5000,  // 5 seconds
    maxP95: 8000,      // 8 seconds
    regressionThreshold: 0.2  // 20% slower triggers alert
  },
  'mind-analysis-full-pipeline': {
    maxAvgTime: 30000, // 30 seconds
    maxP95: 60000,     // 60 seconds
    regressionThreshold: 0.2
  },
  'validation-tasks-extraction': {
    maxAvgTime: 1000,  // 1 second
    maxP95: 2000,
    regressionThreshold: 0.3
  },
  'dna-synthesis': {
    maxAvgTime: 3000,
    maxP95: 5000,
    regressionThreshold: 0.2
  }
};
```

### Benchmark CLI Command

```typescript
// packages/cli/src/commands/benchmark.ts

export const benchmarkCommand = new Command('benchmark')
  .description('Run performance benchmarks')
  .option('-n, --name <name>', 'Run specific benchmark')
  .option('--save', 'Save results as new baseline')
  .option('--compare', 'Compare with baseline')
  .action(async (options) => {
    const suite = new BenchmarkSuite();

    if (options.name) {
      suite.register(options.name, getBenchmark(options.name));
    } else {
      for (const benchmark of CLONE_LAB_BENCHMARKS) {
        suite.register(benchmark.name, benchmark);
      }
    }

    const report = await suite.runAll();

    if (options.compare) {
      const baseline = await loadBaseline();
      report.comparison = compareReports(baseline, report);
    }

    if (options.save) {
      await saveBaseline(report);
    }

    printReport(report);
  });
```

---

## Business Value

Performance Benchmarking garante que o sistema mantém performance aceitável e detecta regressões.

**Benefícios:** Detecção de regressões, baseline de performance, otimização guiada

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Benchmarks não representativos | Medium | Medium | Cenários realistas |
| Flutuação nos resultados | High | Low | Múltiplas iterações |
| Overhead de execução | Low | Low | Execução sob demanda |

---

## Scope

### In Scope
- BenchmarkSuite class
- Clone Lab benchmarks
- Performance thresholds
- CLI command
- Baseline comparison

### Out of Scope
- Continuous benchmarking
- Distributed benchmarks
- Performance profiling

---

## Dependencies

| Dependency | Type | Status |
|------------|------|--------|
| All Phase 1-4 stories | Package | Pending |
| CL2-062 (Alert System) | Package | Pending |

---

## File List

| File | Action | Status |
|------|--------|--------|
| `packages/meta/src/benchmarks/suite.ts` | Create | Pending |
| `packages/meta/src/benchmarks/clone-lab-benchmarks.ts` | Create | Pending |
| `packages/meta/src/benchmarks/thresholds.ts` | Create | Pending |
| `packages/meta/src/benchmarks/index.ts` | Create | Pending |
| `packages/cli/src/commands/benchmark.ts` | Create | Pending |
| `packages/meta/src/benchmarks/__tests__/suite.test.ts` | Create | Pending |

---

## Definition of Done

- [ ] BenchmarkSuite runs correctly
- [ ] All Clone Lab benchmarks implemented
- [ ] Thresholds enforced
- [ ] CLI command works
- [ ] Baseline comparison works
- [ ] Lint passa sem erros
- [ ] Code review aprovado

---

## QA Checklist

- [ ] Benchmarks run successfully
- [ ] Results are accurate
- [ ] Thresholds trigger alerts
- [ ] Baseline comparison works
- [ ] CLI command functional

---

## Change Log

| Date | Author | Description |
|------|--------|-------------|
| 2026-02-20 | Morgan (PM) | Story created |

---

*Story generated by Morgan (PM Agent) - AIOS Framework*
