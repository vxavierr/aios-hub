# Story CL2-056: Human Approval Workflow

**Story ID:** CL2-056
**Epic:** EPIC-CLONE-LAB-V2
**Phase:** 5 - Self-Evolution
**Status:** Ready
**Points:** 5
**Author:** Morgan (PM)

---

## Description

Implementar o **Human Approval Workflow** - sistema que gerencia melhorias que requerem aprovação humana, incluindo fila de pendências, notificações, e processo de aprovação/rejeição.

### Problem Statement
Algumas melhorias identificadas pelo sistema são muito arriscadas para serem aplicadas automaticamente e precisam de aprovação humana antes de serem implementadas.

---

## Acceptance Criteria

```gherkin
Given an improvement requires human approval
When it is identified
Then it is added to the pending approvals queue

Given there are pending approvals
When a reviewer checks the queue
Then all pending items are displayed with relevant information

Given a reviewer approves an improvement
When the approval is recorded
Then the improvement is queued for application

Given a reviewer rejects an improvement
When the rejection is recorded
Then the improvement is marked as rejected with reason

Given an approval is pending for too long
When the timeout expires
Then a reminder is sent or escalation occurs
```

---

## Technical Requirements

### Approval Queue Manager

```typescript
// packages/meta/src/approval/queue-manager.ts

export interface PendingApproval {
  id: string;
  improvement: ImprovementCandidate;
  submittedAt: Date;
  submittedBy: 'system' | 'user';
  urgency: 'low' | 'medium' | 'high' | 'critical';
  status: 'pending' | 'approved' | 'rejected' | 'expired';
  expiresAt?: Date;
  approvals: Approval[];
  rejections: Rejection[];
  comments: Comment[];
}

export interface Approval {
  reviewerId: string;
  approvedAt: Date;
  comment?: string;
}

export class ApprovalQueueManager {
  private readonly queue: Map<string, PendingApproval>;
  private readonly notifiers: Notifier[];
  private readonly config: ApprovalConfig;

  constructor(config: ApprovalConfig, notifiers: Notifier[]) {
    this.queue = new Map();
    this.notifiers = notifiers;
    this.config = config;
  }

  async submit(improvement: ImprovementCandidate): Promise<string> {
    const approval: PendingApproval = {
      id: generateId(),
      improvement,
      submittedAt: new Date(),
      submittedBy: 'system',
      urgency: this.calculateUrgency(improvement),
      status: 'pending',
      approvals: [],
      rejections: [],
      comments: []
    };

    if (this.config.expirationDays) {
      approval.expiresAt = addDays(new Date(), this.config.expirationDays);
    }

    this.queue.set(approval.id, approval);
    await this.notifyNewPending(approval);

    return approval.id;
  }

  async approve(
    approvalId: string,
    reviewerId: string,
    comment?: string
  ): Promise<void> {
    const approval = this.queue.get(approvalId);
    if (!approval) throw new Error(`Approval not found: ${approvalId}`);

    if (approval.status !== 'pending') {
      throw new Error(`Approval already ${approval.status}`);
    }

    approval.approvals.push({
      reviewerId,
      approvedAt: new Date(),
      comment
    });

    // Check if enough approvals
    if (approval.approvals.length >= this.config.requiredApprovals) {
      approval.status = 'approved';
      await this.onApproved(approval);
    }
  }

  async reject(
    approvalId: string,
    reviewerId: string,
    reason: string
  ): Promise<void> {
    const approval = this.queue.get(approvalId);
    if (!approval) throw new Error(`Approval not found: ${approvalId}`);

    approval.rejections.push({
      reviewerId,
      rejectedAt: new Date(),
      reason
    });
    approval.status = 'rejected';

    await this.onRejected(approval);
  }

  getPending(): PendingApproval[] {
    return Array.from(this.queue.values())
      .filter(a => a.status === 'pending')
      .sort((a, b) => this.compareUrgency(b.urgency, a.urgency));
  }

  getApproved(): PendingApproval[] {
    return Array.from(this.queue.values())
      .filter(a => a.status === 'approved');
  }

  private async onApproved(approval: PendingApproval): Promise<void> {
    // Queue for application
    await this.applyImprovement(approval.improvement);

    // Notify
    await this.notifyApproved(approval);
  }

  private calculateUrgency(improvement: ImprovementCandidate): Urgency {
    if (improvement.impact === 'high' && improvement.riskLevel > 50) {
      return 'critical';
    }
    if (improvement.impact === 'high') return 'high';
    if (improvement.impact === 'medium') return 'medium';
    return 'low';
  }
}
```

### Notification System

```typescript
// packages/meta/src/approval/notifiers.ts

export interface Notifier {
  notifyNew(approval: PendingApproval): Promise<void>;
  notifyApproved(approval: PendingApproval): Promise<void>;
  notifyRejected(approval: PendingApproval): Promise<void>;
  notifyReminder(approvals: PendingApproval[]): Promise<void>;
}

export class ConsoleNotifier implements Notifier {
  async notifyNew(approval: PendingApproval): Promise<void> {
    console.log(`[APPROVAL REQUIRED] ${approval.improvement.reason}`);
    console.log(`  ID: ${approval.id}`);
    console.log(`  Urgency: ${approval.urgency}`);
  }

  async notifyApproved(approval: PendingApproval): Promise<void> {
    console.log(`[APPROVED] ${approval.improvement.reason}`);
  }

  async notifyRejected(approval: PendingApproval): Promise<void> {
    console.log(`[REJECTED] ${approval.improvement.reason}`);
  }

  async notifyReminder(approvals: PendingApproval[]): Promise<void> {
    console.log(`[REMINDER] ${approvals.length} pending approvals`);
  }
}

export class EmailNotifier implements Notifier {
  constructor(private readonly emailService: EmailService) {}

  async notifyNew(approval: PendingApproval): Promise<void> {
    await this.emailService.send({
      to: this.getReviewers(),
      subject: `[Clone Lab] Approval Required: ${approval.improvement.target}`,
      body: this.formatApprovalEmail(approval)
    });
  }
}
```

---

## Business Value

O Human Approval Workflow garante que **melhorias arriscadas** sejam revisadas por humanos antes de serem aplicadas, prevenindo desastres enquanto permite melhoria contínua.

**Benefícios:**
- Controle humano sobre mudanças críticas
- Fila organizada de pendências
- Notificações automáticas
- Auditoria completa de aprovações
- Prevenção de mudanças não autorizadas

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Gargalo de aprovações | Medium | Medium | Auto-expiration + escalation |
| Reviewer indisponível | Medium | High | Múltiplos reviewers + timeout |
| Aprovação incorreta | Low | High | Comentários obrigatórios + rollback |

---

## Scope

### In Scope
- ApprovalQueueManager class
- Console and file notifiers
- Approval/rejection workflow
- Expiration handling
- Comment system

### Out of Scope
- Email/SMS notifications
- Multi-tenant approval
- Approval analytics

---

## Dependencies

| Dependency | Type | Status |
|------------|------|--------|
| CL2-036 (Auto-Improvement Engine) | Package | Ready |
| CL2-034 (Constitution Rules) | Package | Pending |

---

## Dev Notes

### Approval Configuration

```yaml
approval_workflow:
  required_approvals: 1
  expiration_days: 7
  reminder_interval_hours: 24
  escalation_after_hours: 72
  auto_reject_on_expiration: false
```

---

## File List

| File | Action | Status |
|------|--------|--------|
| `packages/meta/src/approval/queue-manager.ts` | Create | Pending |
| `packages/meta/src/approval/notifiers.ts` | Create | Pending |
| `packages/meta/src/approval/types.ts` | Create | Pending |
| `packages/meta/src/approval/index.ts` | Create | Pending |
| `packages/meta/src/approval/__tests__/queue-manager.test.ts` | Create | Pending |

---

## Definition of Done

- [ ] Queue manager stores pending approvals
- [ ] Approve/reject workflow works
- [ ] Notifications sent on new items
- [ ] Expiration handled correctly
- [ ] Comments stored with approvals
- [ ] Lint passa sem erros
- [ ] Code review aprovado

---

## QA Checklist

- [ ] Approvals queued correctly
- [ ] Approval workflow works
- [ ] Rejection workflow works
- [ ] Notifications sent
- [ ] Expiration handled

---

## Change Log

| Date | Author | Description |
|------|--------|-------------|
| 2026-02-20 | Morgan (PM) | Story created |

---

*Story generated by Morgan (PM Agent) - AIOS Framework*
