# Story CL2-010: Mind Orchestrator & Router

**Story ID:** CL2-010
**Epic:** EPIC-CLONE-LAB-V2
**Phase:** 1 - Foundation
**Status:** Ready
**Points:** 8
**Author:** Morgan (PM)

---

## Description

Criar o **Mind Orchestrator** que coordena a execução das 8 Minds, gerenciando dependências, contexto compartilhado, e handoffs entre minds.

### Problem Statement
As 8 Minds precisam ser coordenadas em uma ordem específica, com dependências respeitadas e contexto compartilhado entre elas. O Orchestrator gerencia este fluxo complexo.

---

## Acceptance Criteria

```gherkin
Given all 8 minds are registered
When an analysis is requested
Then the orchestrator executes minds in dependency order

Given a mind depends on another mind's results
When the orchestrator runs
Then the dependent mind receives the previous results

Given multiple minds can run in parallel
When the orchestrator executes
Then parallel minds run concurrently

Given a mind fails during execution
When the orchestrator handles the failure
Then appropriate error handling and recovery occurs
```

---

## Technical Requirements

### Orchestrator Architecture

```typescript
// packages/orchestrator/src/coordinator/workflow-coordinator.ts

export interface OrchestratorConfig {
  parallel: boolean;              // Run independent minds in parallel
  timeout: number;                // Max time per mind
  retryCount: number;             // Retries on failure
  stopOnFailure: boolean;         // Stop pipeline on mind failure
}

export class MindOrchestrator {
  private minds: Map<MindId, IMind>;
  private context: SharedContext;
  private results: Map<MindId, MindResult>;

  constructor(
    minds: IMind[],
    private config: OrchestratorConfig
  ) {
    this.minds = new Map(minds.map(m => [m.persona.id, m]));
  }

  async execute(extractedData: ExtractedData[]): Promise<OrchestrationResult> {
    // 1. Build execution plan based on dependencies
    const plan = this.buildExecutionPlan();

    // 2. Initialize shared context
    this.context = new SharedContext(extractedData);

    // 3. Execute in waves (parallel where possible)
    for (const wave of plan.waves) {
      await this.executeWave(wave);
    }

    // 4. Return combined results
    return this.buildResult();
  }

  private buildExecutionPlan(): ExecutionPlan {
    // Topological sort of minds based on dependencies
    // Returns waves of minds that can run in parallel
  }

  private async executeWave(mindIds: MindId[]): Promise<void> {
    if (this.config.parallel && mindIds.length > 1) {
      await Promise.all(mindIds.map(id => this.executeMind(id)));
    } else {
      for (const id of mindIds) {
        await this.executeMind(id);
      }
    }
  }

  private async executeMind(mindId: MindId): Promise<void> {
    const mind = this.minds.get(mindId);
    if (!mind) throw new Error(`Mind not found: ${mindId}`);

    const context = this.buildContext(mindId);

    try {
      const result = await mind.analyze(context);
      this.results.set(mindId, result);
      this.context.addResult(mindId, result);
    } catch (error) {
      this.handleMindError(mindId, error);
    }
  }
}
```

### Execution Plan (Dependency Graph)

```
Wave 1 (Parallel):
  └── Tim (no dependencies)

Wave 2 (Parallel):
  ├── Daniel (depends on Tim)
  ├── Brene (depends on Tim)
  └── Barbara (depends on Tim)

Wave 3:
  └── Charlie (depends on Daniel, Brene, Barbara)

Wave 4:
  └── Constantin (depends on Charlie)

Wave 5 (Parallel):
  ├── Quinn (depends on Constantin)
  └── Victoria (depends on Constantin)
```

### Agent Router

```typescript
// packages/orchestrator/src/router/agent-router.ts

export class AgentRouter {
  private minds: Map<MindId, IMind>;

  // Route to specific mind
  routeTo(mindId: MindId): IMind {
    const mind = this.minds.get(mindId);
    if (!mind) throw new Error(`Unknown mind: ${mindId}`);
    return mind;
  }

  // Find best mind for a task
  findBestMind(task: AnalysisTask): MindId {
    for (const [id, mind] of this.minds) {
      if (mind.canHandle(task.context)) {
        return id;
      }
    }
    throw new Error('No mind can handle this task');
  }

  // Get minds by expertise
  getByExpertise(expertise: string): IMind[] {
    return Array.from(this.minds.values())
      .filter(m => m.persona.expertise.includes(expertise));
  }
}
```

### Shared Context

```typescript
// packages/orchestrator/src/context/shared-context.ts

export class SharedContext {
  private results: Map<MindId, MindResult>;
  private extractedData: ExtractedData[];
  private metadata: Record<string, unknown>;

  constructor(extractedData: ExtractedData[]) {
    this.extractedData = extractedData;
    this.results = new Map();
  }

  addResult(mindId: MindId, result: MindResult): void {
    this.results.set(mindId, result);
  }

  getResult(mindId: MindId): MindResult | undefined {
    return this.results.get(mindId);
  }

  getPreviousResults(forMind: MindId): Map<MindId, MindResult> {
    const mind = this.getMind(forMind);
    const dependencies = mind.getDependencies();
    const relevant = new Map<MindId, MindResult>();

    for (const dep of dependencies) {
      const result = this.results.get(dep);
      if (result) relevant.set(dep, result);
    }

    return relevant;
  }
}
```

---

## Business Value

O Orchestrator é o **cérebro do sistema** - coordena todas as 8 minds, gerencia dependências e contexto. Sem ele, as minds não podem trabalhar juntas de forma coesa.

**Benefícios:**
- Execução automática em ordem correta de dependências
- Paralelização de minds independentes (performance)
- Contexto compartilhado entre minds (evita reprocessamento)
- Error handling centralizado (resiliência)
- Habilita todo o pipeline de análise de personalidade

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Dependência circular não detectada | Low | Critical | Validação no buildExecutionPlan |
| Deadlock em execução paralela | Medium | High | Timeouts + async-mutex |
| Contexto corrompido entre minds | Low | High | Immutability + snapshots |
| Performance bottleneck | Medium | Medium | Profiling + otimização de ondas |

---

## Scope

### In Scope
- MindOrchestrator class
- Execution plan builder (topological sort)
- Wave execution (parallel and sequential)
- AgentRouter for mind selection
- SharedContext for result sharing
- Error handling and recovery
- Unit and integration tests

### Out of Scope
- CLI integration
- Persistence
- Distributed execution

---

## Dependencies

| Dependency | Type | Status |
|------------|------|--------|
| CL2-001 to CL2-009 (All Minds) | Package | Pending |
| @clone-lab/core types | Package | Available |

---

## Dev Notes

- Use `async-mutex` for thread-safe context access
- Consider using RxJS for streaming results
- Add telemetry hooks for observability
- Design for future distributed execution

---

## File List

| File | Action | Status |
|------|--------|--------|
| `packages/orchestrator/package.json` | Create | Pending |
| `packages/orchestrator/src/coordinator/workflow-coordinator.ts` | Create | Pending |
| `packages/orchestrator/src/router/agent-router.ts` | Create | Pending |
| `packages/orchestrator/src/context/shared-context.ts` | Create | Pending |
| `packages/orchestrator/src/handoff/agent-handoff.ts` | Create | Pending |
| `packages/orchestrator/src/index.ts` | Create | Pending |
| `packages/orchestrator/__tests__/orchestrator.test.ts` | Create | Pending |

---

## Definition of Done

- [ ] Orchestrator executes minds in correct order
- [ ] Dependencies are respected
- [ ] Parallel execution works correctly
- [ ] Context is properly shared between minds
- [ ] Error handling works as expected
- [ ] Timeout handling works
- [ ] Integration tests com todas as 8 minds
- [ ] Performance: 8 minds em < 30s
- [ ] Lint passa sem erros
- [ ] Code review aprovado

---

## QA Checklist

- [ ] Orchestrator executes minds in correct order
- [ ] Dependencies are respected
- [ ] Parallel execution works correctly
- [ ] Context is properly shared between minds
- [ ] Error handling works as expected
- [ ] Timeout handling works
- [ ] All tests pass

---

## Change Log

| Date | Author | Description |
|------|--------|-------------|
| 2026-02-20 | Morgan (PM) | Story created |

---

*Story generated by Morgan (PM Agent) - AIOS Framework*
