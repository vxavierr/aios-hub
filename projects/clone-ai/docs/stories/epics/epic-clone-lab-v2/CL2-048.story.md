# Story CL2-048: CLI Evolution Commands

**Story ID:** CL2-048
**Epic:** EPIC-CLONE-LAB-V2
**Phase:** 4 - Integration
**Status:** Ready
**Points:** 5
**Author:** Morgan (PM)

---

## Description

Implementar comandos CLI para visualizar e gerenciar a evolucao do sistema. Usuarios devem poder ver historico de melhorias, rollback changes, e visualizar evolution reports.

### Problem Statement
O sistema de auto-evolucao precisa de interface CLI para que usuarios e administradores possam acompanhar e gerenciar as mudancas automaticas no sistema.

---

## Acceptance Criteria

```gherkin
Given the user runs evolution history command
When evolution changes exist
Then all changes are displayed with details

Given the user runs evolution show command
When a valid change ID is provided
Then full change details are displayed

Given the user runs evolution rollback command
When a change is selected
Then the system reverts to previous state

Given the user runs evolution report command
When a time period is specified
Then an evolution report is generated
```

---

## Technical Requirements

### CLI Evolution Commands

```typescript
// packages/cli/src/commands/evolution/index.ts

import { Command } from 'commander';

export const evolutionCommand = new Command('evolution')
  .alias('evo')
  .description('Manage system evolution and self-improvements')
  .addCommand(historyCommand)
  .addCommand(showCommand)
  .addCommand(rollbackCommand)
  .addCommand(reportCommand)
  .addCommand(pendingCommand);
```

### History Command

```typescript
// packages/cli/src/commands/evolution/history.ts

export const historyCommand = new Command('history')
  .alias('log')
  .description('Show evolution change history')
  .option('-l, --limit <number>', 'Number of changes to show', '20')
  .option('-s, --since <date>', 'Show changes since date')
  .option('-t, --type <type>', 'Filter by change type (add, remove, modify, optimize)')
  .option('--json', 'Output as JSON')
  .action(async (options) => {
    const evolutionLog = await getEvolutionLog();
    const changes = await evolutionLog.getHistory({
      limit: parseInt(options.limit),
      since: options.since,
      type: options.type
    });

    if (changes.length === 0) {
      console.log('No evolution changes found.');
      return;
    }

    if (options.json) {
      console.log(JSON.stringify(changes, null, 2));
    } else {
      console.log(formatEvolutionHistory(changes));
    }
  });

function formatEvolutionHistory(changes: AppliedImprovement[]): string {
  const lines = [
    chalk.bold('Evolution History'),
    chalk.bold('================='),
    ''
  ];

  for (const change of changes) {
    const icon = getChangeIcon(change.improvement.category);
    const status = change.rolledBack ? chalk.gray('[rolled back]') : '';
    const applied = change.appliedBy === 'auto'
      ? chalk.blue('[auto]')
      : chalk.green('[human]');

    lines.push(
      `${icon} ${chalk.bold(change.id)} ${applied} ${status}`,
      `   ${change.improvement.reason}`,
      `   Target: ${change.improvement.target}`,
      `   Applied: ${formatDate(change.appliedAt)}`,
      ''
    );
  }

  return lines.join('\n');
}

function getChangeIcon(category: string): string {
  switch (category) {
    case 'add': return chalk.green('+');
    case 'remove': return chalk.red('-');
    case 'modify': return chalk.yellow('~');
    case 'optimize': return chalk.cyan('*');
    default: return '>';
  }
}
```

### Show Command

```typescript
// packages/cli/src/commands/evolution/show.ts

export const showCommand = new Command('show')
  .description('Show detailed information about a change')
  .argument('<change-id>', 'Change ID to show')
  .option('--diff', 'Show before/after diff')
  .option('--impact', 'Show impact measurement')
  .action(async (changeId, options) => {
    const evolutionLog = await getEvolutionLog();
    const change = await evolutionLog.getChange(changeId);

    if (!change) {
      console.error(`Change ${changeId} not found.`);
      process.exit(1);
    }

    console.log(formatChangeDetails(change));

    if (options.diff) {
      console.log('\n' + chalk.bold('Changes:'));
      console.log(formatDiff(change.beforeState, change.afterState));
    }

    if (options.impact && change.impactMeasurement) {
      console.log('\n' + chalk.bold('Impact Measurement:'));
      console.log(formatImpact(change.impactMeasurement));
    }
  });

function formatChangeDetails(change: AppliedImprovement): string {
  const lines = [
    chalk.bold(`Change: ${change.id}`),
    chalk.bold('='.repeat(50)),
    '',
    `Category: ${change.improvement.category}`,
    `Target: ${change.improvement.target}`,
    `Reason: ${change.improvement.reason}`,
    '',
    `Applied: ${formatDate(change.appliedAt)}`,
    `Applied By: ${change.appliedBy}`,
    `Risk Level: ${change.improvement.riskLevel}/100`,
    `Predicted Benefit: ${change.improvement.predictedBenefit}/100`,
    '',
    `Status: ${change.rolledBack ? chalk.red('Rolled Back') : chalk.green('Active')}`,
    `Rollback Possible: ${change.improvement.rollbackPossible ? 'Yes' : 'No'}`
  ];

  return lines.join('\n');
}
```

### Rollback Command

```typescript
// packages/cli/src/commands/evolution/rollback.ts

export const rollbackCommand = new Command('rollback')
  .description('Rollback an evolution change')
  .argument('[change-id]', 'Change ID to rollback (omit for interactive)')
  .option('-f, --force', 'Skip confirmation')
  .option('-r, --reason <reason>', 'Reason for rollback')
  .action(async (changeId, options) => {
    const rollbackManager = await getRollbackManager();
    const evolutionLog = await getEvolutionLog();

    let targetChangeId = changeId;

    // Interactive selection if no ID provided
    if (!targetChangeId) {
      const recentChanges = await evolutionLog.getRollbackableChanges(10);
      if (recentChanges.length === 0) {
        console.log('No changes available for rollback.');
        return;
      }

      const answer = await inquirer.prompt([
        {
          type: 'list',
          name: 'changeId',
          message: 'Select change to rollback:',
          choices: recentChanges.map(c => ({
            name: `${c.id} - ${c.improvement.reason}`,
            value: c.id
          }))
        }
      ]);
      targetChangeId = answer.changeId;
    }

    const change = await evolutionLog.getChange(targetChangeId);
    if (!change) {
      console.error(`Change ${targetChangeId} not found.`);
      process.exit(1);
    }

    if (change.rolledBack) {
      console.error('This change has already been rolled back.');
      process.exit(1);
    }

    if (!change.improvement.rollbackPossible) {
      console.error('This change cannot be rolled back.');
      process.exit(1);
    }

    // Show what will be rolled back
    console.log(formatChangeDetails(change));

    // Confirm
    if (!options.force) {
      const confirmed = await inquirer.prompt([
        {
          type: 'confirm',
          name: 'rollback',
          message: chalk.red('Are you sure you want to rollback this change?'),
          default: false
        }
      ]);

      if (!confirmed.rollback) {
        console.log('Rollback cancelled.');
        return;
      }
    }

    // Execute rollback
    const result = await rollbackManager.rollback(targetChangeId, {
      reason: options.reason || 'Manual rollback via CLI',
      rolledBackBy: getCurrentUser()
    });

    if (result.success) {
      console.log(chalk.green(`Change ${targetChangeId} rolled back successfully.`));
      console.log('System has been restored to previous state.');
    } else {
      console.error(chalk.red('Rollback failed:'), result.error);
      process.exit(1);
    }
  });
```

### Report Command

```typescript
// packages/cli/src/commands/evolution/report.ts

export const reportCommand = new Command('report')
  .description('Generate evolution report')
  .option('-p, --period <period>', 'Time period (week, month, quarter)', 'month')
  .option('-o, --output <file>', 'Output file path')
  .option('--format <format>', 'Output format (text, json, markdown)', 'text')
  .action(async (options) => {
    const reportGenerator = await getReportGenerator();

    const period = parsePeriod(options.period);
    const report = await reportGenerator.generateEvolutionReport(period);

    const formatted = formatReport(report, options.format);

    if (options.output) {
      await fs.writeFile(options.output, formatted);
      console.log(`Report saved to ${options.output}`);
    } else {
      console.log(formatted);
    }
  });

function formatReport(report: EvolutionReport, format: string): string {
  switch (format) {
    case 'json':
      return JSON.stringify(report, null, 2);
    case 'markdown':
      return formatReportMarkdown(report);
    default:
      return formatReportText(report);
  }
}

function formatReportText(report: EvolutionReport): string {
  const lines = [
    chalk.bold('Evolution Report'),
    chalk.bold('================'),
    `Period: ${report.period.start} to ${report.period.end}`,
    '',
    chalk.bold('Summary:'),
    `  Total Changes: ${report.summary.totalChanges}`,
    `  Auto-applied: ${report.summary.autoApplied}`,
    `  Human-approved: ${report.summary.humanApproved}`,
    `  Rolled back: ${report.summary.rolledBack}`,
    '',
    chalk.bold('By Category:'),
    `  Additions: ${report.byCategory.add}`,
    `  Removals: ${report.byCategory.remove}`,
    `  Modifications: ${report.byCategory.modify}`,
    `  Optimizations: ${report.byCategory.optimize}`,
    '',
    chalk.bold('Impact:'),
    `  Positive: ${report.impact.positive}`,
    `  Neutral: ${report.impact.neutral}`,
    `  Negative: ${report.impact.negative} (rolled back)`,
    '',
    chalk.bold('Top Improvements:'),
    ...report.topImprovements.map((imp, i) =>
      `  ${i + 1}. ${imp.reason} (${imp.benefit}% benefit)`
    )
  ];

  return lines.join('\n');
}
```

### Pending Command

```typescript
// packages/cli/src/commands/evolution/pending.ts

export const pendingCommand = new Command('pending')
  .description('Show pending improvements awaiting approval')
  .option('--approve <id>', 'Approve a pending improvement')
  .option('--reject <id>', 'Reject a pending improvement')
  .option('-r, --reason <reason>', 'Reason for approval/rejection')
  .action(async (options) => {
    const approvalQueue = await getApprovalQueue();

    if (options.approve) {
      await approvalQueue.approve(options.approve, {
        reason: options.reason,
        approvedBy: getCurrentUser()
      });
      console.log(chalk.green(`Improvement ${options.approve} approved.`));
      return;
    }

    if (options.reject) {
      if (!options.reason) {
        console.error('Reason is required for rejection.');
        process.exit(1);
      }
      await approvalQueue.reject(options.reject, {
        reason: options.reason,
        rejectedBy: getCurrentUser()
      });
      console.log(chalk.red(`Improvement ${options.reject} rejected.`));
      return;
    }

    // Show pending
    const pending = await approvalQueue.getPending();
    if (pending.length === 0) {
      console.log('No pending improvements.');
      return;
    }

    console.log(formatPendingList(pending));
  });
```

---

## Business Value

Comandos CLI para evolucao permitem administradores gerenciarem a auto-evolucao do sistema de forma transparente e controlada.

**Beneficios:**
- Visibilidade completa de mudancas
- Rollback facil e seguro
- Relatorios periodicos
- Controle sobre melhorias pendentes
- Audit trail via CLI

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Rollback de mudanca critica | Low | Critical | Confirmacao obrigatoria + warnings |
| Relatorio muito longo | Medium | Low | Paginacao e filtros |
| Aprovacao indevida | Low | Medium | Log de quem aprovou |
| CLI lento com muito historico | Low | Low | Paginacao + cache |

---

## Scope

### In Scope
- evolution history command
- evolution show command
- evolution rollback command
- evolution report command
- evolution pending command
- Interactive selection
- Multiple output formats

### Out of Scope
- Web dashboard
- Real-time evolution monitoring
- Distributed rollback

---

## Dependencies

| Dependency | Type | Status |
|------------|------|--------|
| CL2-038 (Rollback Manager) | Package | Pending |
| CL2-041 (Evolution Log) | Package | Pending |
| CL2-043 (Report Generator) | Package | Pending |
| CLI Package | Package | Available |

---

## Dev Notes

### Period Parsing

```typescript
function parsePeriod(period: string): DateRange {
  const now = new Date();
  switch (period) {
    case 'week':
      return {
        start: subWeeks(now, 1),
        end: now
      };
    case 'month':
      return {
        start: subMonths(now, 1),
        end: now
      };
    case 'quarter':
      return {
        start: subMonths(now, 3),
        end: now
      };
    default:
      throw new Error(`Unknown period: ${period}`);
  }
}
```

---

## File List

| File | Action | Status |
|------|--------|--------|
| `packages/cli/src/commands/evolution/index.ts` | Create | Pending |
| `packages/cli/src/commands/evolution/history.ts` | Create | Pending |
| `packages/cli/src/commands/evolution/show.ts` | Create | Pending |
| `packages/cli/src/commands/evolution/rollback.ts` | Create | Pending |
| `packages/cli/src/commands/evolution/report.ts` | Create | Pending |
| `packages/cli/src/commands/evolution/pending.ts` | Create | Pending |
| `packages/cli/src/commands/evolution/format.ts` | Create | Pending |
| `packages/cli/src/__tests__/evolution.test.ts` | Create | Pending |

---

## Definition of Done

- [ ] evolution history displays changes
- [ ] evolution show displays details
- [ ] evolution rollback works safely
- [ ] evolution report generates correctly
- [ ] evolution pending manages queue
- [ ] Interactive selection works
- [ ] Multiple output formats supported
- [ ] Lint passa sem erros
- [ ] Code review aprovado

---

## QA Checklist

- [ ] All commands execute correctly
- [ ] Rollback confirmation works
- [ ] Reports generate for all periods
- [ ] Pending approval flow works
- [ ] Output formatting is clear
- [ ] Error handling is robust

---

## Change Log

| Date | Author | Description |
|------|--------|-------------|
| 2026-02-20 | Morgan (PM) | Story created |

---

*Story generated by Morgan (PM Agent) - AIOS Framework*
