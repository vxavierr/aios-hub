# Story CL2-034: Constitution Rules Definition

**Story ID:** CL2-034
**Epic:** EPIC-CLONE-LAB-V2
**Phase:** 3 - Meta-Cognition
**Status:** Ready
**Points:** 5
**Author:** Morgan (PM)

---

## Description

Implementar o sistema de **Constitution Rules** - regras que governam o que o sistema pode e não pode fazer automaticamente, definindo limites para auto-modificação.

### Problem Statement
O Clone Lab precisa de regras claras que definam o que pode ser modificado automaticamente e o que requer aprovação humana. O Constitution Rules system estabelece estes limites de segurança.

---

## Acceptance Criteria

```gherkin
Given a constitution rule exists
When a change is proposed
Then the rule is evaluated to determine if the change is allowed

Given a change violates a MUST rule
When the constitution is checked
Then the change is rejected automatically

Given a change triggers a SHOULD rule warning
When the constitution is checked
Then a warning is logged but the change may proceed

Given new rules need to be added
When the constitution is updated
Then the rules are versioned and auditable
```

---

## Technical Requirements

### Constitution Rule System

```typescript
// packages/meta/src/constitution/rules.ts

export type RuleSeverity = 'must' | 'should' | 'may';
export type RuleVerdict = 'allow' | 'warn' | 'reject';

export interface ConstitutionRule {
  id: string;
  name: string;
  description: string;
  severity: RuleSeverity;
  category: RuleCategory;
  check: (candidate: ImprovementCandidate) => RuleVerdict;
  message: string;              // Message when triggered
  exceptions?: RuleException[];
}

export type RuleCategory =
  | 'safety'        // Protects critical functionality
  | 'quality'       // Ensures quality standards
  | 'security'      // Security-related restrictions
  | 'compliance'    // External compliance requirements
  | 'operational';  // Operational boundaries

export interface RuleException {
  condition: string;
  description: string;
  requiresApproval: boolean;
}

export interface RuleEvaluationResult {
  ruleId: string;
  verdict: RuleVerdict;
  message: string;
  exception?: RuleException;
}

// Pre-defined Constitution Rules
export const CONSTITUTION_RULES: ConstitutionRule[] = [
  // === SAFETY RULES ===
  {
    id: 'SAFE-001',
    name: 'No Core File Modification',
    description: 'Core system files cannot be modified without human approval',
    severity: 'must',
    category: 'safety',
    check: (c) => {
      const protectedPatterns = [
        /^packages\/core\//,
        /^packages\/orchestrator\//,
        /^\.aios-core\//
      ];
      return protectedPatterns.some(p => p.test(c.target)) ? 'reject' : 'allow';
    },
    message: 'Changes to core files require human approval',
    exceptions: [
      {
        condition: 'Minor configuration update',
        description: 'Non-breaking config changes',
        requiresApproval: false
      }
    ]
  },

  {
    id: 'SAFE-002',
    name: 'No Checkpoint Removal',
    description: 'Human checkpoints cannot be removed automatically',
    severity: 'must',
    category: 'safety',
    check: (c) => {
      if (c.category === 'remove' && /^checkpoints\//.test(c.target)) {
        return 'reject';
      }
      return 'allow';
    },
    message: 'Checkpoint removal requires human approval'
  },

  {
    id: 'SAFE-003',
    name: 'No Mind Deletion',
    description: 'Minds cannot be deleted automatically',
    severity: 'must',
    category: 'safety',
    check: (c) => {
      if (c.category === 'remove' && /^minds\/(tim|daniel|brene|barbara|charlie|constantin|quinn|victoria)$/.test(c.target)) {
        return 'reject';
      }
      return 'allow';
    },
    message: 'Mind deletion requires human approval'
  },

  // === QUALITY RULES ===
  {
    id: 'QUAL-001',
    name: 'Test Coverage Threshold',
    description: 'Changes must not reduce test coverage below 80%',
    severity: 'must',
    category: 'quality',
    check: (c) => {
      if (c.category === 'remove' && /__tests__|\.test\./.test(c.target)) {
        return 'warn';
      }
      return 'allow';
    },
    message: 'Test file removal should be reviewed for coverage impact'
  },

  {
    id: 'QUAL-002',
    name: 'Risk Threshold',
    description: 'Changes above risk level 70 require human approval',
    severity: 'must',
    category: 'quality',
    check: (c) => {
      if (c.riskLevel > 70) {
        return 'reject';
      }
      if (c.riskLevel > 50) {
        return 'warn';
      }
      return 'allow';
    },
    message: 'High-risk changes require human approval'
  },

  // === SECURITY RULES ===
  {
    id: 'SEC-001',
    name: 'No Credential Files',
    description: 'Credential-related files cannot be modified',
    severity: 'must',
    category: 'security',
    check: (c) => {
      const sensitivePatterns = [
        /\.env/,
        /credentials/,
        /secrets/,
        /api[-_]?key/i,
        /password/i
      ];
      return sensitivePatterns.some(p => p.test(c.target)) ? 'reject' : 'allow';
    },
    message: 'Credential file changes are not allowed'
  },

  {
    id: 'SEC-002',
    name: 'No Database Schema Auto-Changes',
    description: 'Database schema changes require human approval',
    severity: 'must',
    category: 'security',
    check: (c) => {
      if (/schema|migration/.test(c.target)) {
        return 'reject';
      }
      return 'allow';
    },
    message: 'Database schema changes require human approval'
  },

  // === OPERATIONAL RULES ===
  {
    id: 'OPS-001',
    name: 'Rate Limiting',
    description: 'Maximum 5 auto-changes per day',
    severity: 'must',
    category: 'operational',
    check: (c) => {
      // This is checked externally by the engine
      return 'allow';
    },
    message: 'Daily auto-change limit reached'
  },

  {
    id: 'OPS-002',
    name: 'Rollback Required',
    description: 'All changes must have rollback capability',
    severity: 'must',
    category: 'operational',
    check: (c) => {
      return c.rollbackPossible ? 'allow' : 'reject';
    },
    message: 'Changes without rollback capability are not allowed'
  },

  {
    id: 'OPS-003',
    name: 'Audit Trail Required',
    description: 'All changes must be logged to evolution log',
    severity: 'must',
    category: 'operational',
    check: () => 'allow', // Always allow, logging is enforced elsewhere
    message: 'Evolution log is mandatory'
  }
];
```

### Rule Registry

```typescript
// packages/meta/src/constitution/registry.ts

export class ConstitutionRegistry {
  private rules: Map<string, ConstitutionRule>;
  private versionHistory: ConstitutionVersion[];

  constructor(initialRules: ConstitutionRule[] = []) {
    this.rules = new Map(initialRules.map(r => [r.id, r]));
    this.versionHistory = [];
  }

  addRule(rule: ConstitutionRule): void {
    if (this.rules.has(rule.id)) {
      throw new Error(`Rule ${rule.id} already exists`);
    }
    this.rules.set(rule.id, rule);
  }

  updateRule(ruleId: string, update: Partial<ConstitutionRule>): void {
    const existing = this.rules.get(ruleId);
    if (!existing) {
      throw new Error(`Rule ${ruleId} not found`);
    }

    // Create version snapshot before update
    this.versionHistory.push({
      ruleId,
      previousVersion: { ...existing },
      timestamp: new Date(),
      changeDescription: update.description || 'Rule updated'
    });

    this.rules.set(ruleId, { ...existing, ...update });
  }

  getRule(ruleId: string): ConstitutionRule | undefined {
    return this.rules.get(ruleId);
  }

  getAllRules(): ConstitutionRule[] {
    return Array.from(this.rules.values());
  }

  getRulesByCategory(category: RuleCategory): ConstitutionRule[] {
    return this.getAllRules().filter(r => r.category === category);
  }

  getVersionHistory(ruleId?: string): ConstitutionVersion[] {
    if (ruleId) {
      return this.versionHistory.filter(v => v.ruleId === ruleId);
    }
    return this.versionHistory;
  }
}
```

### Rule Configuration

```yaml
# packages/meta/src/constitution/config.yaml

constitution:
  version: "1.0.0"
  lastUpdated: "2026-02-20"

  # Global settings
  settings:
    maxAutoChangesPerDay: 5
    cooldownHours: 4
    requireReviewAfterConsecutiveAuto: 3

  # Rule categories with default behaviors
  categories:
    safety:
      autoApply: false
      requireApproval: true
    quality:
      autoApply: conditional
      approvalThreshold: 50
    security:
      autoApply: false
      requireApproval: always
    compliance:
      autoApply: false
      requireApproval: always
    operational:
      autoApply: true
      requireApproval: conditional

  # Exception handling
  exceptions:
    allowOverride: false
    overrideRequiresApproval: true
    maxOverrideDuration: 24h
```

---

## Business Value

O Constitution Rules system é a **salvaguarda do sistema** - garante que auto-modificações não quebrem funcionalidade crítica ou causem danos.

**Benefícios:**
- Limites claros para auto-modificação
- Proteção de componentes críticos
- Auditoria de regras e mudanças
- Conformidade com requisitos de segurança

---

## Risks

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Rules too restrictive | Medium | Medium | Periodic rule review |
| Rules bypassed by bugs | Low | Critical | Multiple enforcement points |
| Rules become outdated | Medium | Medium | Regular review cycle |

---

## Scope

### In Scope
- ConstitutionRule interface and types
- 10+ pre-defined rules (safety, quality, security, operational)
- ConstitutionRegistry for rule management
- Rule versioning and history
- Configuration file

### Out of Scope
- Rule UI/editor
- Dynamic rule loading
- External compliance integration

---

## Dependencies

| Dependency | Type | Status |
|------------|------|--------|
| CL2-028 (Meta Package Setup) | Package | Pending |
| @clone-lab/core | Package | Available |

---

## Dev Notes

### Rule Evaluation Order

```typescript
// Rules are evaluated in order: MUST > SHOULD > MAY
// First rejection wins
const evaluationOrder = ['must', 'should', 'may'];
```

### Rule Categories Priority

1. **Safety** - Always checked first
2. **Security** - Checked second
3. **Compliance** - Checked third
4. **Quality** - Checked fourth
5. **Operational** - Checked last

---

## File List

| File | Action | Status |
|------|--------|--------|
| `packages/meta/src/constitution/rules.ts` | Create | Pending |
| `packages/meta/src/constitution/registry.ts` | Create | Pending |
| `packages/meta/src/constitution/config.yaml` | Create | Pending |
| `packages/meta/src/constitution/types.ts` | Create | Pending |
| `packages/meta/src/constitution/index.ts` | Create | Pending |
| `packages/meta/src/constitution/__tests__/rules.test.ts` | Create | Pending |

---

## Definition of Done

- [ ] All rule types defined
- [ ] 10+ pre-defined rules implemented
- [ ] Registry manages rules correctly
- [ ] Version history works
- [ ] Configuration loaded correctly
- [ ] Lint passa sem erros
- [ ] Code review aprovado

---

## QA Checklist

- [ ] All rule types defined
- [ ] 10+ pre-defined rules implemented
- [ ] Registry manages rules correctly
- [ ] Version history works
- [ ] Configuration loaded correctly
- [ ] All tests pass

---

## Change Log

| Date | Author | Description |
|------|--------|-------------|
| 2026-02-20 | Morgan (PM) | Story created |

---

*Story generated by Morgan (PM Agent) - AIOS Framework*
